<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roadmap Nevent 2025‚Äì2026</title>
  <style>
    :root{
      --bg:#0A0A0A; --card:#141414; --ink:#FFFFFF; --muted:#BBBBBB; --stroke:#333;
      --accent1:#EC008C; --accent2:#5CC2E5; --accent3:#91194a; --brand:#EC008C;
      --prio-high:#e74c3c; --prio-med:#f1c40f; --prio-low:#2ecc71;
      --success:#2ecc71; --warning:#f39c12; --danger:#e74c3c; --info:#3498db;
    }
    html[data-theme="light"]{
      --bg:#F7F7F9; --card:#FFFFFF; --ink:#0B0B0F; --muted:#60646c; --stroke:#E6E6EC;
      --accent1:#D40A80; --accent2:#2E97B6; --accent3:#7d1240; --brand:#D40A80;
    }

    *{box-sizing:border-box; margin:0; padding:0}
    body{background:var(--bg); color:var(--ink); font:15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; transition:background 0.3s ease}
    .wrap{max-width:1800px; margin:20px auto; padding:20px;}
    
    .header{text-align:center; padding:40px 20px; background:linear-gradient(135deg, var(--accent1), var(--accent2)); border-radius:20px; margin-bottom:30px; box-shadow:0 10px 40px rgba(0,0,0,0.3); position:relative}
    h1{font-size:clamp(28px, 5vw, 42px); font-weight:900; color:#fff; margin:0; text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
    .subtitle{color:rgba(255,255,255,0.9); margin-top:8px; font-size:16px}
    .sync-status{position:absolute; top:20px; right:20px; background:rgba(0,0,0,0.3); padding:8px 16px; border-radius:20px; font-size:13px; display:flex; align-items:center; gap:8px}
    .sync-indicator{width:10px; height:10px; border-radius:50%; background:var(--success); animation:pulse 2s infinite}
    .sync-indicator.offline{background:var(--danger); animation:none}
    @keyframes pulse{0%,100%{opacity:1} 50%{opacity:0.5}}

    .config-banner{background:var(--warning); color:#000; padding:16px; text-align:center; border-radius:12px; margin-bottom:20px; font-weight:600}
    .config-banner button{background:#000; color:#fff; border:none; padding:8px 20px; border-radius:8px; cursor:pointer; font-weight:700; margin-left:10px}
    .config-banner button:hover{opacity:0.8}

    .topbar{display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; margin-bottom:25px; position:sticky; top:10px; z-index:100; background:var(--card); padding:15px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.15); border:2px solid var(--stroke)}
    .btn{border:2px solid var(--stroke); background:var(--card); color:var(--ink); padding:10px 16px; border-radius:12px; cursor:pointer; font-weight:600; transition:all 0.3s ease; display:inline-flex; align-items:center; gap:8px; font-size:14px}
    .btn:hover{transform:translateY(-2px); box-shadow:0 4px 12px rgba(236,0,140,0.3); border-color:var(--brand)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:var(--brand); color:#fff; border-color:var(--brand)}
    .btn.primary:hover{background:var(--accent3)}
    .btn.success{background:var(--success); color:#fff; border-color:var(--success)}
    .btn.danger{background:var(--danger); color:#fff; border-color:var(--danger)}
    .btn:disabled{opacity:0.5; cursor:not-allowed}

    .theme-toggle{display:flex; align-items:center; gap:10px}
    .switch{position:relative; width:60px; height:30px; background:var(--stroke); border-radius:999px; cursor:pointer; transition:background 0.3s}
    .switch:hover{background:var(--accent2)}
    .switch input{display:none}
    .knob{position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%; background:#fff; display:flex; align-items:center; justify-content:center; font-size:14px; transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow:0 2px 8px rgba(0,0,0,0.2)}
    .switch input:checked + .knob{left:33px; background:#000; color:#fff}

    /* Modal */
    .modal{display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); animation:fadeIn 0.3s}
    .modal.active{display:flex; align-items:center; justify-content:center}
    .modal-content{background:var(--card); border:2px solid var(--stroke); border-radius:20px; padding:30px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto; animation:slideUp 0.3s}
    @keyframes fadeIn{from{opacity:0} to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(50px); opacity:0} to{transform:translateY(0); opacity:1}}
    .modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px}
    .modal-header h2{color:var(--accent2); font-size:24px}
    .modal-close{cursor:pointer; font-size:28px; color:var(--muted); transition:color 0.2s}
    .modal-close:hover{color:var(--danger)}
    
    .form-group{margin-bottom:20px}
    .form-group label{display:block; margin-bottom:8px; font-weight:600; color:var(--accent2)}
    .form-group input, .form-group select, .form-group textarea{width:100%; padding:12px; border-radius:10px; border:2px solid var(--stroke); background:var(--bg); color:var(--ink); font-size:14px; font-family:inherit}
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus{outline:none; border-color:var(--accent2)}
    .form-group textarea{min-height:100px; resize:vertical}
    .form-group.inline{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px}
    
    .subtask-list{display:flex; flex-direction:column; gap:8px}
    .subtask-item{display:flex; gap:8px; align-items:center}
    .subtask-item input{flex:1}
    .subtask-item button{padding:8px; border:none; background:var(--danger); color:#fff; border-radius:8px; cursor:pointer}

    /* Timeline */
    .timeline-container{margin-top:30px}
    .quarter-section{margin-bottom:40px; background:var(--card); border:2px solid var(--stroke); border-radius:20px; padding:24px}
    .quarter-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px}
    .quarter-header h2{color:var(--accent2); font-size:28px}
    .quarter-actions{display:flex; gap:10px}
    
    .actions-grid{display:grid; gap:20px; grid-template-columns:repeat(auto-fill, minmax(350px, 1fr))}
    .action-card{background:rgba(255,255,255,0.03); border:2px solid var(--stroke); border-radius:16px; padding:20px; transition:all 0.3s; position:relative}
    .action-card:hover{transform:translateY(-4px); box-shadow:0 8px 24px rgba(0,0,0,0.3); border-color:var(--accent1)}
    .action-card.completed{opacity:0.7; border-color:var(--success)}
    
    .action-header{display:flex; justify-content:space-between; align-items:start; margin-bottom:12px}
    .action-title{font-size:18px; font-weight:700; color:var(--accent1); flex:1; padding-right:10px}
    .action-badges{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px}
    .badge{font-size:11px; padding:4px 8px; border-radius:6px; font-weight:700; text-transform:uppercase}
    .badge.priority-high{background:var(--prio-high); color:#fff}
    .badge.priority-med{background:var(--prio-med); color:#000}
    .badge.priority-low{background:var(--prio-low); color:#fff}
    .badge.status{background:var(--info); color:#fff}
    .badge.status-completed{background:var(--success)}
    .badge.status-progress{background:var(--warning); color:#000}
    
    .action-description{color:var(--muted); font-size:14px; margin-bottom:12px; line-height:1.6}
    .action-meta{display:flex; flex-direction:column; gap:6px; font-size:13px; margin-bottom:12px}
    .action-meta div{display:flex; align-items:center; gap:6px}
    .action-meta .responsable{color:var(--accent2); font-weight:600}
    .action-meta .deadline{color:var(--accent3); font-weight:600}
    
    .subtasks-list{margin:12px 0; padding-left:8px}
    .subtasks-list li{margin:6px 0; list-style:none; display:flex; align-items:center; gap:8px; padding:6px; border-radius:6px; transition:background 0.2s}
    .subtasks-list li:hover{background:rgba(255,255,255,0.05)}
    .subtasks-list input{margin:0; width:18px; height:18px; cursor:pointer; accent-color:var(--accent2)}
    .subtasks-list label{cursor:pointer; flex:1; transition:all 0.2s}
    .subtasks-list input:checked + label{text-decoration:line-through; opacity:0.6}
    
    .progress-bar{height:10px; background:rgba(255,255,255,0.1); border-radius:999px; overflow:hidden; margin-top:12px}
    .progress-fill{height:100%; background:linear-gradient(90deg, var(--accent2), var(--accent1)); transition:width 0.5s}
    
    .action-footer{display:flex; gap:8px; margin-top:12px; padding-top:12px; border-top:1px solid var(--stroke)}
    .action-footer button{flex:1; padding:8px; border:none; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600; transition:all 0.2s}
    .action-footer .btn-edit{background:var(--info); color:#fff}
    .action-footer .btn-delete{background:var(--danger); color:#fff}
    .action-footer button:hover{opacity:0.8; transform:translateY(-2px)}

    .notifications{position:fixed; top:20px; right:20px; z-index:1001; display:flex; flex-direction:column; gap:10px; max-width:350px}
    .notification{background:var(--card); border:2px solid var(--accent2); border-radius:12px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,0.3); animation:slideInRight 0.3s; display:flex; align-items:start; gap:12px}
    .notification.warning{border-color:var(--warning)}
    .notification.error{border-color:var(--danger)}
    .notification.success{border-color:var(--success)}
    .notification .icon{font-size:24px}
    .notification .content{flex:1; font-size:14px}
    .notification .close{cursor:pointer; opacity:0.6; transition:opacity 0.2s; font-size:20px; line-height:1}
    .notification .close:hover{opacity:1}
    @keyframes slideInRight{from{transform:translateX(400px); opacity:0} to{transform:translateX(0); opacity:1}}

    .summary{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin:25px 0}
    .summary-item{background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:20px; text-align:center; transition:all 0.3s ease; cursor:pointer}
    .summary-item:hover{transform:translateY(-4px); box-shadow:0 8px 24px rgba(0,0,0,0.2); border-color:var(--accent2)}
    .summary-item .icon{font-size:32px; margin-bottom:10px}
    .summary-item h2{margin:8px 0; font-size:28px; color:var(--accent2); font-weight:800}
    .summary-item p{margin:4px 0 0; color:var(--muted); font-size:14px}

    .empty-state{text-align:center; padding:60px 20px; color:var(--muted)}
    .empty-state .icon{font-size:64px; margin-bottom:16px; opacity:0.5}
    .empty-state h3{font-size:20px; margin-bottom:8px}

    .loading{display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:2000}
    .loading.active{display:block}
    .spinner{width:60px; height:60px; border:6px solid var(--stroke); border-top-color:var(--accent2); border-radius:50%; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:768px){
      .wrap{padding:15px}
      .actions-grid{grid-template-columns:1fr}
      .topbar{flex-direction:column; position:relative; top:0}
      .btn{width:100%}
      .sync-status{position:static; margin-top:10px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="sync-status" id="syncStatus">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span id="syncText">Sin configurar</span>
      </div>
      <h1>üöÄ Roadmap Nevent 2025‚Äì2026</h1>
      <div class="subtitle">Sistema sincronizado en tiempo real con Supabase</div>
    </div>

    <div class="notifications" id="notifications"></div>
    <div class="loading" id="loading"><div class="spinner"></div></div>

    <!-- Config Banner -->
    <div class="config-banner" id="configBanner" style="display:none">
      ‚ö†Ô∏è Supabase no configurado. Los datos solo se guardan localmente.
      <button onclick="openConfigModal()">‚öôÔ∏è Configurar ahora</button>
    </div>

    <div class="topbar">
      <button class="btn primary" onclick="openAddActionModal()">‚ûï Nueva Acci√≥n</button>
      <button class="btn" onclick="syncNow()" id="btnSync">üîÑ Sincronizar</button>
      <button class="btn" onclick="openConfigModal()">‚öôÔ∏è Config Supabase</button>
      <button class="btn" onclick="exportData()">üì• Exportar</button>
      <button class="btn danger" onclick="resetAllData()">üóëÔ∏è Reset</button>
      <div class="theme-toggle">
        <label class="switch">
          <input type="checkbox" id="themeSwitch"/>
          <span class="knob">üåô</span>
        </label>
      </div>
    </div>

    <div class="summary">
      <div class="summary-item">
        <div class="icon">üìã</div>
        <h2 id="sum-actions">0</h2>
        <p>Acciones totales</p>
      </div>
      <div class="summary-item">
        <div class="icon">‚úÖ</div>
        <h2 id="sum-done">0</h2>
        <p>Completadas</p>
      </div>
      <div class="summary-item">
        <div class="icon">üë•</div>
        <h2 id="sum-resp">0</h2>
        <p>Responsables</p>
      </div>
      <div class="summary-item">
        <div class="icon">üìä</div>
        <h2 id="sum-progress">0%</h2>
        <p>Progreso global</p>
      </div>
    </div>

    <div class="timeline-container" id="timelineContainer"></div>
  </div>

  <!-- Config Modal -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚öôÔ∏è Configuraci√≥n Supabase</h2>
        <span class="modal-close" onclick="closeConfigModal()">&times;</span>
      </div>
      <form id="configForm" onsubmit="saveConfig(event)">
        <div class="form-group">
          <label>Project URL</label>
          <input type="url" id="supabaseUrl" placeholder="https://xxxxx.supabase.co" required>
          <small style="color:var(--muted); font-size:12px">Encu√©ntralo en: Settings ‚Üí API ‚Üí Project URL</small>
        </div>
        <div class="form-group">
          <label>Anon Public Key</label>
          <input type="text" id="supabaseKey" placeholder="eyJhbGci..." required>
          <small style="color:var(--muted); font-size:12px">Encu√©ntralo en: Settings ‚Üí API ‚Üí anon public</small>
        </div>
        <div style="background:rgba(92,194,229,0.1); padding:16px; border-radius:12px; margin:16px 0">
          <strong style="color:var(--accent2)">üìö Tutorial r√°pido:</strong>
          <ol style="margin:10px 0 0 20px; line-height:2">
            <li>Ve a <a href="https://supabase.com" target="_blank" style="color:var(--accent2)">supabase.com</a></li>
            <li>Sign up (gratis)</li>
            <li>New Project ‚Üí Guarda la password</li>
            <li>Settings ‚Üí API ‚Üí Copia URL y Key</li>
            <li>P√©galos aqu√≠ arriba</li>
          </ol>
        </div>
        <div style="display:flex; gap:12px">
          <button type="button" class="btn" onclick="closeConfigModal()" style="flex:1">Cancelar</button>
          <button type="submit" class="btn primary" style="flex:1">üíæ Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Action Modal -->
  <div id="actionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Nueva Acci√≥n</h2>
        <span class="modal-close" onclick="closeActionModal()">&times;</span>
      </div>
      <form id="actionForm" onsubmit="saveAction(event)">
        <input type="hidden" id="actionId">
        <input type="hidden" id="actionQuarter">
        
        <div class="form-group">
          <label>Trimestre</label>
          <select id="quarterSelect" required>
            <option value="Q4 2025">Q4 2025</option>
            <option value="Q1 2026">Q1 2026</option>
            <option value="Q2 2026">Q2 2026</option>
            <option value="Q3 2026">Q3 2026</option>
            <option value="Q4 2026">Q4 2026</option>
          </select>
        </div>

        <div class="form-group inline">
          <div>
            <label>Categor√≠a</label>
            <select id="categorySelect" required>
              <option value="Marketing">Marketing</option>
              <option value="Customer Success">Customer Success</option>
              <option value="Expansi√≥n">Expansi√≥n</option>
              <option value="Producto">Producto</option>
              <option value="Ventas">Ventas</option>
            </select>
          </div>
          <div>
            <label>Prioridad</label>
            <select id="prioritySelect" required>
              <option value="Alta">Alta</option>
              <option value="Media">Media</option>
              <option value="Baja">Baja</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>T√≠tulo</label>
          <input type="text" id="titleInput" required placeholder="Ej: Email fr√≠o creativo">
        </div>

        <div class="form-group">
          <label>Descripci√≥n</label>
          <textarea id="descriptionInput" required placeholder="Describe la acci√≥n..."></textarea>
        </div>

        <div class="form-group inline">
          <div>
            <label>Responsable</label>
            <input type="text" id="responsableInput" required placeholder="Nombre">
          </div>
          <div>
            <label>Deadline</label>
            <input type="date" id="deadlineInput" required>
          </div>
        </div>

        <div class="form-group">
          <label>Subtareas</label>
          <div class="subtask-list" id="subtaskList"></div>
          <button type="button" class="btn" onclick="addSubtaskField()" style="margin-top:10px; width:100%">‚ûï Agregar Subtarea</button>
        </div>

        <div style="display:flex; gap:12px; margin-top:24px">
          <button type="button" class="btn" onclick="closeActionModal()" style="flex:1">Cancelar</button>
          <button type="submit" class="btn primary" style="flex:1">üíæ Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // =============== SUPABASE CONFIG ===============
    let supabase = null;
    let supabaseConfig = {
      url: '',
      key: ''
    };

    // =============== DATA STRUCTURE ===============
    let roadmapData = {
      quarters: {
        'Q4 2025': [],
        'Q1 2026': [],
        'Q2 2026': [],
        'Q3 2026': [],
        'Q4 2026': []
      }
    };

    // =============== INITIALIZATION ===============
    async function init() {
      setupTheme();
      loadSupabaseConfig();
      await loadData();
      renderTimeline();
      updateSummary();
      
      // Setup realtime subscriptions if configured
      if (supabase) {
        setupRealtimeSync();
      }
      
      setTimeout(() => {
        showNotification('üëã Sistema listo', 'success', 2000);
      }, 500);
    }

    // =============== SUPABASE SETUP ===============
    function loadSupabaseConfig() {
      try {
        const saved = localStorage.getItem('supabase_config');
        if (saved) {
          supabaseConfig = JSON.parse(saved);
          if (supabaseConfig.url && supabaseConfig.key) {
            initSupabase();
            document.getElementById('configBanner').style.display = 'none';
          } else {
            document.getElementById('configBanner').style.display = 'block';
            updateSyncStatus('offline', 'Sin configurar');
          }
        } else {
          document.getElementById('configBanner').style.display = 'block';
          updateSyncStatus('offline', 'Sin configurar');
        }
      } catch (e) {
        console.error('Error loading config:', e);
      }
    }

    function initSupabase() {
      try {
        supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.key);
        updateSyncStatus('online', 'Conectado');
        checkDatabase();
      } catch (e) {
        console.error('Error initializing Supabase:', e);
        updateSyncStatus('offline', 'Error conexi√≥n');
        showNotification('Error al conectar con Supabase', 'error');
      }
    }

    async function checkDatabase() {
      if (!supabase) return;
      
      try {
        // Check if table exists, if not, we'll create it via SQL editor instruction
        const { data, error } = await supabase
          .from('roadmap_actions')
          .select('count')
          .limit(1);
        
        if (error) {
          if (error.message.includes('relation "roadmap_actions" does not exist')) {
            showNotification('‚ö†Ô∏è Necesitas crear la tabla en Supabase. Ve al SQL Editor', 'warning', 0);
            showDatabaseSetupInstructions();
          }
        }
      } catch (e) {
        console.error('Error checking database:', e);
      }
    }

    function showDatabaseSetupInstructions() {
      const sql = `
-- Copia y pega este SQL en: Supabase ‚Üí SQL Editor ‚Üí New Query

CREATE TABLE roadmap_actions (
  id TEXT PRIMARY KEY,
  quarter TEXT NOT NULL,
  category TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  priority TEXT,
  status TEXT,
  responsable TEXT,
  deadline DATE,
  subtasks JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Enable realtime
ALTER PUBLICATION supabase_realtime ADD TABLE roadmap_actions;
      `;
      
      showNotification(`
        <strong>üìã Configuraci√≥n de Base de Datos</strong><br><br>
        1. Ve a tu proyecto en Supabase<br>
        2. Click en "SQL Editor" (izquierda)<br>
        3. "New Query"<br>
        4. Copia y pega el SQL de la consola<br>
        5. Click "Run"<br><br>
        <button onclick="navigator.clipboard.writeText(\`${sql}\`); showNotification('SQL copiado al portapapeles', 'success')" 
                style="background:var(--success); color:#fff; border:none; padding:8px 16px; border-radius:8px; cursor:pointer">
          üìã Copiar SQL
        </button>
      `, 'info', 0);
      
      console.log('=== SQL PARA SUPABASE ===');
      console.log(sql);
      console.log('========================');
    }

    function saveConfig(event) {
      event.preventDefault();
      
      supabaseConfig.url = document.getElementById('supabaseUrl').value.trim();
      supabaseConfig.key = document.getElementById('supabaseKey').value.trim();
      
      localStorage.setItem('supabase_config', JSON.stringify(supabaseConfig));
      
      initSupabase();
      closeConfigModal();
      
      showNotification('‚úÖ Configuraci√≥n guardada. Sincronizando...', 'success');
      
      setTimeout(() => {
        syncNow();
      }, 1000);
    }

    function openConfigModal() {
      document.getElementById('supabaseUrl').value = supabaseConfig.url || '';
      document.getElementById('supabaseKey').value = supabaseConfig.key || '';
      document.getElementById('configModal').classList.add('active');
    }

    function closeConfigModal() {
      document.getElementById('configModal').classList.remove('active');
    }

    // =============== REALTIME SYNC ===============
    function setupRealtimeSync() {
      if (!supabase) return;
      
      const channel = supabase
        .channel('roadmap_changes')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'roadmap_actions' },
          (payload) => {
            console.log('Realtime update:', payload);
            loadData();
            renderTimeline();
            updateSummary();
            showNotification('üîÑ Datos actualizados', 'info', 2000);
          }
        )
        .subscribe();
    }

    async function syncNow() {
      if (!supabase) {
        showNotification('Supabase no configurado', 'warning');
        return;
      }
      
      showLoading(true);
      updateSyncStatus('syncing', 'Sincronizando...');
      
      try {
        // Upload local data to Supabase
        const allActions = [];
        Object.keys(roadmapData.quarters).forEach(quarter => {
          roadmapData.quarters[quarter].forEach(action => {
            allActions.push({
              id: action.id,
              quarter: quarter,
              category: action.category,
              title: action.title,
              description: action.description,
              priority: action.priority,
              status: action.status,
              responsable: action.responsable,
              deadline: action.deadline,
              subtasks: action.subtasks
            });
          });
        });
        
        if (allActions.length > 0) {
          const { error } = await supabase
            .from('roadmap_actions')
            .upsert(allActions, { onConflict: 'id' });
          
          if (error) throw error;
        }
        
        // Download data from Supabase
        await loadData();
        renderTimeline();
        updateSummary();
        
        updateSyncStatus('online', 'Sincronizado ‚úì');
        showNotification('‚úÖ Sincronizaci√≥n completada', 'success');
      } catch (e) {
        console.error('Sync error:', e);
        updateSyncStatus('offline', 'Error sync');
        showNotification('Error al sincronizar: ' + e.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    function updateSyncStatus(status, text) {
      const indicator = document.getElementById('syncIndicator');
      const textEl = document.getElementById('syncText');
      
      indicator.className = 'sync-indicator';
      if (status === 'offline') {
        indicator.classList.add('offline');
      }
      
      textEl.textContent = text;
    }

    // =============== DATA PERSISTENCE ===============
    async function loadData() {
      try {
        if (supabase) {
          // Load from Supabase
          const { data, error } = await supabase
            .from('roadmap_actions')
            .select('*')
            .order('created_at', { ascending: true });
          
          if (error) {
            console.error('Supabase error:', error);
            // Fallback to localStorage
            loadFromLocalStorage();
            return;
          }
          
          if (data && data.length > 0) {
            // Reset quarters
            Object.keys(roadmapData.quarters).forEach(q => {
              roadmapData.quarters[q] = [];
            });
            
            // Populate from Supabase
            data.forEach(row => {
              if (roadmapData.quarters[row.quarter]) {
                roadmapData.quarters[row.quarter].push({
                  id: row.id,
                  category: row.category,
                  title: row.title,
                  description: row.description,
                  priority: row.priority,
                  status: row.status,
                  responsable: row.responsable,
                  deadline: row.deadline,
                  subtasks: row.subtasks || []
                });
              }
            });
            
            // Also save to localStorage as backup
            saveToLocalStorage();
          } else {
            loadFromLocalStorage();
          }
        } else {
          loadFromLocalStorage();
        }
      } catch (e) {
        console.error('Error loading data:', e);
        loadFromLocalStorage();
      }
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('nevent_roadmap_data');
      if (saved) {
        roadmapData = JSON.parse(saved);
      } else {
        // Sample data
        roadmapData.quarters['Q4 2025'] = [{
          id: generateId(),
          category: 'Marketing',
          title: 'Email fr√≠o creativo',
          description: 'Email fr√≠o + caso Holika + demo-bait ROI.',
          priority: 'Alta',
          status: 'Pendiente',
          responsable: 'Fran',
          deadline: '2025-11-30',
          subtasks: [
            { id: generateId(), text: 'Copy + secuencia', completed: false },
            { id: generateId(), text: 'Segmentaci√≥n base', completed: false }
          ]
        }];
        saveToLocalStorage();
      }
    }

    function saveToLocalStorage() {
      localStorage.setItem('nevent_roadmap_data', JSON.stringify(roadmapData));
    }

    async function saveToSupabase(action, quarter) {
      if (!supabase) {
        saveToLocalStorage();
        return;
      }
      
      try {
        const { error } = await supabase
          .from('roadmap_actions')
          .upsert({
            id: action.id,
            quarter: quarter,
            category: action.category,
            title: action.title,
            description: action.description,
            priority: action.priority,
            status: action.status,
            responsable: action.responsable,
            deadline: action.deadline,
            subtasks: action.subtasks,
            updated_at: new Date().toISOString()
          }, { onConflict: 'id' });
        
        if (error) throw error;
        
        saveToLocalStorage();
      } catch (e) {
        console.error('Error saving to Supabase:', e);
        showNotification('Error al guardar en Supabase', 'error');
        saveToLocalStorage();
      }
    }

    async function deleteFromSupabase(actionId) {
      if (!supabase) return;
      
      try {
        const { error } = await supabase
          .from('roadmap_actions')
          .delete()
          .eq('id', actionId);
        
        if (error) throw error;
      } catch (e) {
        console.error('Error deleting from Supabase:', e);
      }
    }

    function generateId() {
      return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // =============== THEME ===============
    function setupTheme() {
      const saved = localStorage.getItem('nevent_theme');
      if (saved) document.documentElement.setAttribute('data-theme', saved);
      
      const checkbox = document.getElementById('themeSwitch');
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      checkbox.checked = (current === 'light');
      updateKnobIcon();
      
      checkbox.addEventListener('change', () => {
        const next = checkbox.checked ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('nevent_theme', next);
        updateKnobIcon();
      });
    }

    function updateKnobIcon() {
      const checkbox = document.getElementById('themeSwitch');
      const knob = document.querySelector('.knob');
      knob.textContent = checkbox.checked ? 'üåû' : 'üåô';
    }

    // =============== RENDER TIMELINE ===============
    function renderTimeline() {
      const container = document.getElementById('timelineContainer');
      container.innerHTML = '';

      Object.keys(roadmapData.quarters).forEach(quarter => {
        const actions = roadmapData.quarters[quarter];
        
        const section = document.createElement('div');
        section.className = 'quarter-section';
        section.innerHTML = `
          <div class="quarter-header">
            <h2>${quarter}</h2>
            <div class="quarter-actions">
              <button class="btn success" onclick="openAddActionModal('${quarter}')">‚ûï Nueva</button>
            </div>
          </div>
          <div class="actions-grid" id="actions-${quarter.replace(/\s/g, '-')}"></div>
        `;
        
        container.appendChild(section);
        
        if (actions.length === 0) {
          const grid = section.querySelector('.actions-grid');
          grid.innerHTML = `
            <div class="empty-state">
              <div class="icon">üì≠</div>
              <h3>No hay acciones aqu√≠</h3>
            </div>
          `;
        } else {
          renderActions(quarter, actions);
        }
      });
    }

    function renderActions(quarter, actions) {
      const grid = document.getElementById('actions-' + quarter.replace(/\s/g, '-'));
      
      actions.forEach(action => {
        const card = createActionCard(action, quarter);
        grid.appendChild(card);
      });
    }

    function createActionCard(action, quarter) {
      const card = document.createElement('div');
      card.className = 'action-card';
      card.dataset.actionId = action.id;
      
      if (action.status === 'Completado') card.classList.add('completed');
      
      const completedCount = action.subtasks.filter(st => st.completed).length;
      const totalCount = action.subtasks.length;
      const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
      
      const subtasksHtml = action.subtasks.map(st => `
        <li>
          <input type="checkbox" 
                 id="st-${st.id}" 
                 ${st.completed ? 'checked' : ''} 
                 onchange="toggleSubtask('${action.id}', '${st.id}', '${quarter}')">
          <label for="st-${st.id}">${st.text}</label>
        </li>
      `).join('');
      
      card.innerHTML = `
        <div class="action-header">
          <div class="action-title">${action.title}</div>
        </div>
        <div class="action-badges">
          <span class="badge priority-${action.priority.toLowerCase()}">${action.priority}</span>
          <span class="badge status status-${action.status.toLowerCase().replace(/\s/g, '-')}">${action.status}</span>
          <span class="badge">${action.category}</span>
        </div>
        <div class="action-description">${action.description}</div>
        <div class="action-meta">
          <div><span>üë§</span> <span class="responsable">${action.responsable}</span></div>
          <div><span>üìÖ</span> <span class="deadline">${formatDate(action.deadline)}</span></div>
        </div>
        ${action.subtasks.length > 0 ? `
          <ul class="subtasks-list">${subtasksHtml}</ul>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${progress}%"></div>
          </div>
          <div style="font-size:12px; color:var(--muted); margin-top:6px">${completedCount}/${totalCount} (${progress}%)</div>
        ` : ''}
        <div class="action-footer">
          <button class="btn-edit" onclick="editAction('${action.id}', '${quarter}')">‚úèÔ∏è Editar</button>
          <button class="btn-delete" onclick="deleteAction('${action.id}', '${quarter}')">üóëÔ∏è Eliminar</button>
        </div>
      `;
      
      return card;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // =============== MODAL MANAGEMENT ===============
    function openAddActionModal(quarter = '') {
      document.getElementById('modalTitle').textContent = 'Nueva Acci√≥n';
      document.getElementById('actionForm').reset();
      document.getElementById('actionId').value = '';
      document.getElementById('actionQuarter').value = '';
      
      if (quarter) document.getElementById('quarterSelect').value = quarter;
      
      document.getElementById('subtaskList').innerHTML = '';
      addSubtaskField();
      
      document.getElementById('actionModal').classList.add('active');
    }

    function editAction(actionId, quarter) {
      const action = roadmapData.quarters[quarter].find(a => a.id === actionId);
      if (!action) return;
      
      document.getElementById('modalTitle').textContent = 'Editar Acci√≥n';
      document.getElementById('actionId').value = actionId;
      document.getElementById('actionQuarter').value = quarter;
      document.getElementById('quarterSelect').value = quarter;
      document.getElementById('categorySelect').value = action.category;
      document.getElementById('prioritySelect').value = action.priority;
      document.getElementById('titleInput').value = action.title;
      document.getElementById('descriptionInput').value = action.description;
      document.getElementById('responsableInput').value = action.responsable;
      document.getElementById('deadlineInput').value = action.deadline;
      
      const subtaskList = document.getElementById('subtaskList');
      subtaskList.innerHTML = '';
      action.subtasks.forEach(st => addSubtaskField(st.text));
      
      document.getElementById('actionModal').classList.add('active');
    }

    function closeActionModal() {
      document.getElementById('actionModal').classList.remove('active');
    }

    function addSubtaskField(text = '') {
      const subtaskList = document.getElementById('subtaskList');
      const div = document.createElement('div');
      div.className = 'subtask-item';
      div.innerHTML = `
        <input type="text" placeholder="Nombre de la subtarea" value="${text}">
        <button type="button" onclick="this.parentElement.remove()">üóëÔ∏è</button>
      `;
      subtaskList.appendChild(div);
    }

    // =============== CRUD OPERATIONS ===============
    async function saveAction(event) {
      event.preventDefault();
      showLoading(true);
      
      const actionId = document.getElementById('actionId').value;
      const oldQuarter = document.getElementById('actionQuarter').value;
      const quarter = document.getElementById('quarterSelect').value;
      
      const subtaskInputs = document.querySelectorAll('#subtaskList input[type="text"]');
      const subtasks = Array.from(subtaskInputs)
        .map(input => input.value.trim())
        .filter(text => text)
        .map(text => ({ id: generateId(), text, completed: false }));
      
      const actionData = {
        id: actionId || generateId(),
        category: document.getElementById('categorySelect').value,
        title: document.getElementById('titleInput').value,
        description: document.getElementById('descriptionInput').value,
        priority: document.getElementById('prioritySelect').value,
        status: 'Pendiente',
        responsable: document.getElementById('responsableInput').value,
        deadline: document.getElementById('deadlineInput').value,
        subtasks
      };
      
      if (actionId) {
        if (oldQuarter && oldQuarter !== quarter) {
          roadmapData.quarters[oldQuarter] = roadmapData.quarters[oldQuarter].filter(a => a.id !== actionId);
          if (supabase) await deleteFromSupabase(actionId);
        }
        
        const index = roadmapData.quarters[quarter].findIndex(a => a.id === actionId);
        if (index >= 0) {
          const oldAction = roadmapData.quarters[quarter][index];
          actionData.status = oldAction.status;
          actionData.subtasks.forEach(newSt => {
            const oldSt = oldAction.subtasks.find(ost => ost.text === newSt.text);
            if (oldSt) newSt.completed = oldSt.completed;
          });
          roadmapData.quarters[quarter][index] = actionData;
        } else {
          roadmapData.quarters[quarter].push(actionData);
        }
        
        showNotification('‚úÖ Acci√≥n actualizada', 'success');
      } else {
        roadmapData.quarters[quarter].push(actionData);
        showNotification('‚úÖ Acci√≥n creada', 'success');
      }
      
      await saveToSupabase(actionData, quarter);
      renderTimeline();
      updateSummary();
      closeActionModal();
      showLoading(false);
    }

    async function deleteAction(actionId, quarter) {
      if (!confirm('¬øEliminar esta acci√≥n?')) return;
      
      showLoading(true);
      roadmapData.quarters[quarter] = roadmapData.quarters[quarter].filter(a => a.id !== actionId);
      
      await deleteFromSupabase(actionId);
      saveToLocalStorage();
      
      renderTimeline();
      updateSummary();
      showNotification('üóëÔ∏è Acci√≥n eliminada', 'info');
      showLoading(false);
    }

    async function toggleSubtask(actionId, subtaskId, quarter) {
      const action = roadmapData.quarters[quarter].find(a => a.id === actionId);
      if (!action) return;
      
      const subtask = action.subtasks.find(st => st.id === subtaskId);
      if (subtask) {
        subtask.completed = !subtask.completed;
        
        const completedCount = action.subtasks.filter(st => st.completed).length;
        const totalCount = action.subtasks.length;
        
        if (completedCount === totalCount && totalCount > 0) {
          action.status = 'Completado';
        } else if (completedCount > 0) {
          action.status = 'En curso';
        } else {
          action.status = 'Pendiente';
        }
        
        await saveToSupabase(action, quarter);
        renderTimeline();
        updateSummary();
      }
    }

    // =============== SUMMARY ===============
    function updateSummary() {
      let totalActions = 0, completedActions = 0, totalSubtasks = 0, completedSubtasks = 0;
      const responsables = new Set();
      
      Object.values(roadmapData.quarters).forEach(actions => {
        actions.forEach(action => {
          totalActions++;
          if (action.status === 'Completado') completedActions++;
          responsables.add(action.responsable);
          action.subtasks.forEach(st => {
            totalSubtasks++;
            if (st.completed) completedSubtasks++;
          });
        });
      });
      
      const progress = totalSubtasks > 0 ? Math.round((completedSubtasks / totalSubtasks) * 100) : 0;
      
      document.getElementById('sum-actions').textContent = totalActions;
      document.getElementById('sum-done').textContent = completedActions;
      document.getElementById('sum-resp').textContent = responsables.size;
      document.getElementById('sum-progress').textContent = progress + '%';
    }

    // =============== EXPORT ===============
    function exportData() {
      const dataStr = JSON.stringify(roadmapData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `roadmap_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      showNotification('üì• Exportado', 'success');
    }

    async function resetAllData() {
      if (!confirm('‚ö†Ô∏è ¬øBORRAR TODO?')) return;
      if (!confirm('¬øRealmente quieres borrar todo?')) return;
      
      showLoading(true);
      
      if (supabase) {
        const { error } = await supabase.from('roadmap_actions').delete().neq('id', '');
      }
      
      roadmapData = {
        quarters: {
          'Q4 2025': [], 'Q1 2026': [], 'Q2 2026': [], 'Q3 2026': [], 'Q4 2026': []
        }
      };
      
      saveToLocalStorage();
      renderTimeline();
      updateSummary();
      showNotification('üóëÔ∏è Todo eliminado', 'info');
      showLoading(false);
    }

    // =============== UI HELPERS ===============
    function showLoading(show) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    function showNotification(message, type = 'info', duration = 5000) {
      const container = document.getElementById('notifications');
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      
      const icons = {info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è', error: '‚ùå', success: '‚úÖ'};
      notif.innerHTML = `
        <span class="icon">${icons[type]}</span>
        <div class="content">${message}</div>
        <span class="close" onclick="this.parentElement.remove()">√ó</span>
      `;
      
      container.appendChild(notif);
      if (duration > 0) setTimeout(() => notif.remove(), duration);
    }

    // Close modals on outside click
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
