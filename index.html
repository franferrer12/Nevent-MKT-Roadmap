<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🚀 Roadmap Nevent 2025-2026</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
  <style>
    :root {
      /* Base colors */
      --bg: #0A0A0A;
      --card: #141414;
      --ink: #FFFFFF;
      --muted: #BBBBBB;
      --stroke: #333;
      --accent1: #EC008C;
      --accent2: #5CC2E5;
      --brand: #EC008C;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;

      /* Extended palette */
      --accent1-light: #FF1A9E;
      --accent1-dark: #CC0070;
      --accent2-light: #70D9FF;
      --accent2-dark: #4AA8C7;

      /* Neutral scale */
      --neutral-900: #0A0A0A;
      --neutral-800: #141414;
      --neutral-700: #1E1E1E;
      --neutral-600: #2A2A2A;
      --neutral-500: #333333;

      /* Type scale */
      --font-size-display: 56px;
      --font-size-h1: 36px;
      --font-size-h2: 28px;
      --font-size-h3: 22px;
      --font-size-body: 16px;
      --font-size-small: 14px;

      /* Font weights */
      --font-weight-bold: 700;
      --font-weight-semibold: 600;
      --font-weight-medium: 500;

      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;

      /* Border radius */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;

      /* Shadows */
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.4);
      --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.5);

      /* Transitions */
      --transition-fast: 0.15s ease;
      --transition-base: 0.2s ease;
      --transition-slow: 0.3s ease;

      /* Z-index */
      --z-dropdown: 1000;
      --z-modal: 1050;
      --z-toast: 1060;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--ink);
      line-height: 1.6;
    }

    #loginPage {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      background: linear-gradient(135deg, var(--bg) 0%, #1a1a1a 100%);
    }

    .login-container {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    }

    .login-logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-logo h1 {
      font-size: 32px;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .login-logo p {
      color: var(--muted);
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--ink);
      font-weight: 500;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--stroke);
      border-radius: 8px;
      color: var(--ink);
      font-size: 15px;
      transition: all 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent1);
      box-shadow: 0 0 0 3px rgba(236, 0, 140, 0.1);
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: var(--accent1);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
    }

    .login-btn:hover {
      background: #d40080;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(236, 0, 140, 0.3);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-btn:disabled {
      background: var(--stroke);
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
      padding: 12px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    #mainApp {
      display: none;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .container.viewing-as-mode {
      border: 4px solid var(--accent1);
      border-radius: 12px;
      padding: 16px;
      background: linear-gradient(
        to bottom,
        rgba(236, 0, 140, 0.03) 0%,
        transparent 100%
      );
      box-shadow: inset 0 0 20px rgba(236, 0, 140, 0.1), 0 0 30px rgba(236, 0, 140, 0.2);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--stroke);
      flex-wrap: wrap;
      gap: 10px;
    }

    h1 {
      font-size: 36px;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 20px;
      background: var(--card);
      border: 1px solid var(--stroke);
      color: var(--ink);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      position: relative;
    }

    .btn:hover {
      background: var(--stroke);
      transform: translateY(-1px);
    }

    .btn-primary {
      background: var(--accent1);
      border-color: var(--accent1);
      color: white;
    }

    .btn-primary:hover {
      background: #d40080;
    }

    .btn-secondary {
      background: var(--bg);
      border: 1px solid var(--stroke);
      color: var(--ink);
    }

    .btn-secondary:hover {
      background: var(--stroke);
    }

    .btn-danger {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
      font-weight: 600;
    }

    .btn-danger:hover {
      background: #c21f1f;
    }

    /* Loading States */
    .btn.loading {
      pointer-events: none;
      opacity: 0.6;
      position: relative;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      top: 50%;
      left: 50%;
      margin-left: -7px;
      margin-top: -7px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    .btn-secondary.loading::after,
    .btn.loading:not(.btn-primary):not(.btn-danger)::after {
      border-color: rgba(0, 0, 0, 0.2);
      border-top-color: var(--ink);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .form-loading {
      pointer-events: none;
      opacity: 0.5;
      position: relative;
    }

    .form-loading::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      z-index: 10;
      border-radius: 12px;
    }

    .form-loading::after {
      content: '';
      position: absolute;
      width: 32px;
      height: 32px;
      top: 50%;
      left: 50%;
      margin-left: -16px;
      margin-top: -16px;
      border: 3px solid rgba(236, 0, 140, 0.2);
      border-top-color: var(--accent1);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      z-index: 11;
    }
      border-color: #c21f1f;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .logout-btn {
      background: var(--danger) !important;
      border-color: var(--danger) !important;
      color: white !important;
    }

    .logout-btn:hover {
      background: #dc2626 !important;
    }

    /* View As User Selector */
    .view-as-container {
      position: relative;
      display: inline-block;
    }

    .view-as-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      min-width: 320px;
      max-height: 500px;
      overflow-y: auto;
      z-index: 1000;
    }

    .dropdown-header {
      padding: var(--space-md);
      border-bottom: 1px solid var(--stroke);
      font-weight: 600;
      font-size: 14px;
    }

    .dropdown-subtitle {
      display: block;
      font-size: 12px;
      color: var(--muted);
      font-weight: normal;
      margin-top: 4px;
    }

    .user-list {
      padding: var(--space-sm);
    }

    .user-item {
      padding: var(--space-md);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: var(--space-md);
      border: 1px solid transparent;
      margin-bottom: 4px;
    }

    .user-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent1);
    }

    .user-item.active {
      background: rgba(236, 0, 140, 0.1);
      border-color: var(--accent1);
    }

    .user-item-icon {
      font-size: 24px;
      min-width: 32px;
      text-align: center;
    }

    .user-item-info {
      flex: 1;
    }

    .user-item-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .user-item-email {
      font-size: 12px;
      color: var(--muted);
    }

    .user-item-role {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .role-ceo {
      background: var(--accent1);
      color: white;
    }

    .role-director {
      background: var(--accent2);
      color: white;
    }

    .role-csm {
      background: var(--warning);
      color: white;
    }

    .role-user {
      background: var(--stroke);
      color: var(--muted);
    }

    #currentUserBadge {
      font-weight: 600;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: middle;
    }

    .viewing-as-banner {
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      border-bottom: 3px solid var(--accent1);
      padding: var(--space-md) var(--space-lg);
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      color: white;
      box-shadow: 0 4px 12px rgba(236, 0, 140, 0.3);
      position: sticky;
      top: 0;
      z-index: 999;
      animation: slideDown 0.3s ease-out, pulse-banner 2s ease-in-out infinite;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes pulse-banner {
      0%, 100% {
        box-shadow: 0 4px 12px rgba(236, 0, 140, 0.3);
      }
      50% {
        box-shadow: 0 4px 20px rgba(236, 0, 140, 0.5);
      }
    }

    .viewing-as-banner strong {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 12px;
      border-radius: 6px;
      margin: 0 8px;
    }

    .viewing-as-banner .exit-btn {
      margin-left: 16px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      background: white;
      color: var(--accent1);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .viewing-as-banner .exit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      background: rgba(255, 255, 255, 0.95);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-label {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent1);
    }

    .timeline {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .quarter {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 24px;
    }

    .quarter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .quarter-title {
      font-size: 22px;
      font-weight: 700;
    }

    .actions-grid {
      display: grid;
      gap: 16px;
    }

    .action-card {
      background: var(--bg);
      border: 1px solid var(--stroke);
      border-radius: 8px;
      padding: 16px;
      transition: all 0.2s;
    }

    .action-card:hover {
      border-color: var(--accent1);
      transform: translateX(4px);
    }

    .action-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .action-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .action-category {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(236, 0, 140, 0.1);
      color: var(--accent1);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .action-meta {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
    }

    .priority-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .priority-Alta {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .priority-Media {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .priority-Baja {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-Completado {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .status-En.curso {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .status-Pendiente {
      background: rgba(156, 163, 175, 0.2);
      color: var(--muted);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: var(--stroke);
      color: var(--ink);
    }

    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--stroke);
      border-radius: 8px;
      color: var(--ink);
      font-size: 14px;
      font-family: inherit;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .subtasks {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--stroke);
    }

    .subtask {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      margin: 4px 0;
      background: var(--card);
      border-radius: 6px;
    }

    .subtask input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .action-buttons button {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--stroke);
      background: var(--bg);
      color: var(--ink);
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-buttons button:hover {
      background: var(--stroke);
    }

    /* Dashboard Styles */
    .my-dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .dashboard-header h2 {
      font-size: 28px;
      font-weight: 600;
      color: var(--ink);
    }

    .dashboard-actions {
      display: flex;
      gap: 10px;
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .dashboard-stats .stat-card {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .stat-icon {
      font-size: 36px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(99, 102, 241, 0.1));
      border-radius: 12px;
    }

    .stat-content {
      flex: 1;
    }

    .dashboard-section {
      margin-bottom: 40px;
    }

    .dashboard-section h3 {
      font-size: 22px;
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 20px;
    }

    .okrs-list, .initiatives-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
    }

    .okr-card, .initiative-card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .okr-card:hover, .initiative-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .okr-header, .initiative-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .okr-header h4, .initiative-header h4 {
      font-size: 18px;
      font-weight: 600;
      color: var(--ink);
      flex: 1;
      margin-right: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
      font-size: 16px;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      h1 {
        font-size: 24px;
      }

      .header-actions {
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }

      .header-actions .btn {
        width: 100%;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      .okrs-list, .initiatives-list {
        grid-template-columns: 1fr;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
    }

    /* Toast Notification System */
    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 400px;
    }

    .toast {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: start;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }

    .toast:hover {
      transform: translateX(-4px);
    }

    .toast.removing {
      animation: slideOut 0.3s ease-in forwards;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast-icon {
      font-size: 24px;
      flex-shrink: 0;
      line-height: 1;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--ink);
    }

    .toast-message {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* Onboarding Overlay */
    .onboarding-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 10, 10, 0.95);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }

    .onboarding-overlay.active {
      display: flex;
    }

    .onboarding-content {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(236, 0, 140, 0.3);
      animation: fadeInScale 0.4s ease-out;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .onboarding-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .onboarding-header h2 {
      font-size: 32px;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .onboarding-header p {
      color: var(--muted);
      font-size: 16px;
    }

    .onboarding-steps {
      display: grid;
      gap: 20px;
      margin-bottom: 32px;
    }

    .onboarding-step {
      display: flex;
      gap: 16px;
      padding: 20px;
      background: var(--bg);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      transition: all 0.2s;
    }

    .onboarding-step:hover {
      border-color: var(--accent1);
      transform: translateX(4px);
    }

    .onboarding-step-icon {
      font-size: 32px;
      flex-shrink: 0;
      line-height: 1;
    }

    .onboarding-step-content h3 {
      font-size: 18px;
      margin-bottom: 6px;
      color: var(--ink);
    }

    .onboarding-step-content p {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.5;
    }

    .onboarding-footer {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .onboarding-footer .btn {
      min-width: 140px;
    }

    /* Tooltips */
    .tooltip-trigger {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: help;
    }

    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--stroke);
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .tooltip-trigger:hover .tooltip-icon {
      background: var(--accent1);
      color: white;
      transform: scale(1.1);
    }

    .tooltip-content {
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 8px;
      padding: 12px 16px;
      min-width: 280px;
      max-width: 400px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s;
    }

    .tooltip-trigger:hover .tooltip-content {
      opacity: 1;
      pointer-events: auto;
    }

    .tooltip-content::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--stroke);
    }

    .tooltip-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--ink);
    }

    .tooltip-text {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }

    .tooltip-formula {
      margin-top: 8px;
      padding: 8px;
      background: var(--bg);
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--accent2);
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: color 0.2s;
    }

    .toast-close:hover {
      color: var(--ink);
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    .toast.info {
      border-left: 4px solid var(--accent2);
    }

    /* Offline Indicator */
    #offlineIndicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--danger);
      color: white;
      padding: 12px 20px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      z-index: 9999;
      display: none;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
      }
      to {
        transform: translateY(0);
      }
    }

    #offlineIndicator.show {
      display: block;
    }

    @media (max-width: 768px) {
      #toastContainer {
        left: 20px;
        right: 20px;
        max-width: none;
      }
    }

    /* Navigation Tabs System */
    .main-navigation {
      margin-bottom: var(--space-xl);
      border-bottom: 2px solid var(--stroke);
    }

    .nav-tabs {
      display: flex;
      gap: var(--space-xs);
      overflow-x: auto;
      scrollbar-width: none;
    }

    .nav-tabs::-webkit-scrollbar {
      display: none;
    }

    .nav-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--muted);
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      white-space: nowrap;
    }

    .nav-tab:hover {
      color: var(--ink);
      background: rgba(236, 0, 140, 0.05);
    }

    .nav-tab.active {
      color: var(--accent1);
      border-bottom-color: var(--accent1);
    }

    .nav-tab[data-required-role]:not([data-user-has-role]) {
      display: none;
    }

    @media (max-width: 768px) {
      .nav-tab {
        padding: 10px 16px;
        font-size: 13px;
      }

      .tab-label {
        display: none;
      }

      .nav-tab.active .tab-label {
        display: inline;
      }
    }

    /* Segment Tabs for CS Dashboard */
    .segment-tab {
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 12px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .segment-tab:hover {
      color: var(--ink);
      background: rgba(255, 255, 255, 0.05);
    }

    .segment-tab.active {
      color: var(--accent1);
      border-bottom-color: var(--accent1);
    }

    /* CEO Dashboard Styles */
    .ceo-dashboard {
      display: none;
      max-width: 1600px;
      margin: 0 auto;
      padding: var(--space-xl);
    }

    .ceo-dashboard.active {
      display: block;
    }

    .ceo-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }

    .kpi-card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-xl);
      padding: 28px;
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all var(--transition-slow);
      cursor: pointer;
    }

    .kpi-card:hover {
      border-color: var(--accent1);
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }

    .kpi-icon {
      font-size: 48px;
      flex-shrink: 0;
    }

    .kpi-content {
      flex: 1;
    }

    .kpi-label {
      font-size: var(--font-size-small);
      color: var(--muted);
      margin-bottom: var(--space-xs);
    }

    .kpi-value {
      font-size: var(--font-size-display);
      font-weight: var(--font-weight-bold);
      line-height: 1;
      margin-bottom: var(--space-xs);
    }

    .kpi-trend {
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-semibold);
    }

    .kpi-trend.positive {
      color: var(--success);
    }

    .kpi-trend.negative {
      color: var(--danger);
    }

    @media (max-width: 1200px) {
      .ceo-metrics {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .ceo-dashboard {
        padding: var(--space-md);
      }

      .ceo-metrics {
        grid-template-columns: 1fr;
      }

      .kpi-card {
        padding: 20px;
      }

      .kpi-value {
        font-size: 40px;
      }

      .kpi-trend {
        display: none;
      }
    }

    /* Department Health Card Styles */
    .dept-health-card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-xl);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .dept-health-card:hover {
      border-color: var(--accent1);
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }

    .dept-health-icon {
      font-size: 32px;
      margin-bottom: var(--space-md);
    }

    .dept-health-name {
      font-size: 16px;
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-md);
      color: var(--ink);
    }

    .dept-health-score {
      font-size: 48px;
      font-weight: var(--font-weight-bold);
      margin-bottom: 4px;
      line-height: 1;
    }

    .dept-health-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }

    .dept-health-meta {
      margin-top: var(--space-md);
      font-size: 13px;
      color: var(--muted);
    }

    .dept-health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--space-lg);
    }

    @media (max-width: 768px) {
      .dept-health-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Director Dashboard Styles */
    .director-dashboard {
      padding: var(--space-xl);
    }

    .director-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2xl);
      padding-bottom: var(--space-lg);
      border-bottom: 2px solid var(--stroke);
    }

    .director-title {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .director-title h1 {
      font-size: var(--font-size-h1);
      margin: 0;
    }

    .dept-badge {
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      border-radius: var(--radius-lg);
      font-size: 14px;
      font-weight: var(--font-weight-bold);
    }

    .director-actions {
      display: flex;
      gap: var(--space-md);
    }

    .director-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }

    .metric-card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-xl);
      padding: 24px;
      transition: all var(--transition-base);
    }

    .metric-card:hover {
      border-color: var(--accent1);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .metric-label {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 32px;
      font-weight: var(--font-weight-bold);
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .metric-comparison {
      font-size: 13px;
      color: var(--muted);
    }

    .department-okrs {
      margin-bottom: var(--space-2xl);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
    }

    .section-title {
      font-size: var(--font-size-h2);
      margin: 0;
    }

    .okr-kanban {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }

    .kanban-column {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-xl);
      padding: var(--space-lg);
    }

    .kanban-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--stroke);
    }

    .kanban-title {
      font-size: 16px;
      font-weight: var(--font-weight-bold);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .kanban-count {
      background: var(--bg);
      padding: 4px 10px;
      border-radius: var(--radius-md);
      font-size: 12px;
      font-weight: var(--font-weight-bold);
    }

    .okr-card-mini {
      background: var(--bg);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .okr-card-mini:hover {
      border-color: var(--accent1);
      transform: translateX(4px);
    }

    .okr-card-mini h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--ink);
    }

    .okr-card-mini .progress-mini {
      font-size: 12px;
      color: var(--muted);
    }

    .budget-section {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      margin-bottom: var(--space-2xl);
    }

    .budget-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: var(--space-lg);
    }

    .budget-total {
      font-size: 40px;
      font-weight: var(--font-weight-bold);
      color: var(--success);
    }

    .budget-subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .budget-bar {
      height: 40px;
      background: var(--bg);
      border-radius: var(--radius-lg);
      position: relative;
      overflow: hidden;
      margin-bottom: var(--space-md);
    }

    .budget-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent2));
      border-radius: var(--radius-lg);
      transition: width 0.6s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 12px;
      font-weight: var(--font-weight-bold);
      font-size: 14px;
    }

    .budget-breakdown {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-lg);
    }

    .budget-item {
      text-align: center;
    }

    .budget-item-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    .budget-item-value {
      font-size: 20px;
      font-weight: var(--font-weight-bold);
    }

    .team-section {
      margin-bottom: var(--space-2xl);
    }

    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--space-lg);
    }

    .team-member-card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-xl);
      padding: var(--space-lg);
      display: flex;
      gap: var(--space-md);
      transition: all var(--transition-base);
    }

    .team-member-card:hover {
      border-color: var(--accent1);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .member-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }

    .member-info {
      flex: 1;
    }

    .member-name {
      font-size: 16px;
      font-weight: var(--font-weight-bold);
      margin-bottom: 4px;
    }

    .member-role {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .member-okrs {
      font-size: 12px;
      color: var(--muted);
    }

    .member-okrs strong {
      color: var(--success);
    }

    @media (max-width: 1200px) {
      .director-metrics {
        grid-template-columns: repeat(2, 1fr);
      }

      .okr-kanban {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .director-dashboard {
        padding: var(--space-md);
      }

      .director-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-md);
      }

      .director-metrics {
        grid-template-columns: 1fr;
      }

      .budget-breakdown {
        grid-template-columns: 1fr;
      }

      .team-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Offline Indicator -->
  <div id="offlineIndicator">
    ⚠️ Sin conexión a Internet. Algunas funcionalidades pueden no estar disponibles.
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>
  
  <div id="loginPage">
    <div class="login-container">
      <div class="login-logo">
        <h1>🚀 Roadmap Nevent</h1>
        <p>2025-2026</p>
      </div>
      
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input 
            type="email" 
            id="loginEmail" 
            placeholder="tu.email@nevent.es"
            required
            autocomplete="email"
          />
        </div>
        
        <div class="form-group">
          <label for="loginPassword">Contraseña</label>
          <input 
            type="password" 
            id="loginPassword" 
            placeholder="••••••••"
            required
            autocomplete="current-password"
          />
        </div>
        
        <button type="submit" class="login-btn" id="loginBtn">
          Iniciar sesión
        </button>
        
        <div id="loginError" class="error-message"></div>
      </form>
    </div>
  </div>

  <div id="mainApp">
    <div class="container">
      <!-- Viewing As Banner -->
      <div id="viewingAsBanner" class="viewing-as-banner" style="display: none;">
        👁️ Viendo como: <strong id="viewingAsEmail"></strong>
        <button class="exit-btn" onclick="exitViewAsMode()">↩️ Volver a mi cuenta</button>
      </div>

      <header>
        <h1>🚀 Roadmap Nevent 2025-2026</h1>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openAddActionModal()">➕ Nueva Acción</button>
          <button class="btn" onclick="syncData()">🔄 Sincronizar</button>

          <!-- View As User Selector (CEO only) -->
          <div id="viewAsSelector" class="view-as-container" style="display: none;">
            <button class="btn btn-secondary" onclick="toggleViewAsDropdown()" id="viewAsButton">
              👤 <span id="currentUserBadge">Usuario</span> <span style="font-size: 10px;">▼</span>
            </button>
            <div id="viewAsDropdown" class="view-as-dropdown" style="display: none;">
              <div class="dropdown-header">
                🔄 Cambiar vista de usuario
                <span class="dropdown-subtitle">Jerarquía de acceso</span>
              </div>
              <div id="userListContainer" class="user-list">
                <!-- Users will be loaded here -->
              </div>
            </div>
          </div>

          <button class="btn logout-btn" onclick="handleLogout()">🚪 Salir</button>
        </div>
      </header>

      <!-- Navigation Tabs -->
      <nav class="main-navigation" role="navigation" aria-label="Main navigation">
        <div class="nav-tabs">
          <button class="nav-tab active" data-view="timeline" onclick="switchView('timeline')">
            <span class="tab-icon">📊</span>
            <span class="tab-label">Timeline</span>
          </button>
          <button class="nav-tab" data-view="user-dashboard" onclick="switchView('user-dashboard')">
            <span class="tab-icon">👤</span>
            <span class="tab-label">Mi Dashboard</span>
          </button>
          <button class="nav-tab" data-view="ceo-dashboard" data-required-role="ceo" onclick="switchView('ceo-dashboard')">
            <span class="tab-icon">🌍</span>
            <span class="tab-label">CEO Dashboard</span>
          </button>
          <button class="nav-tab" data-view="director-dashboard" data-required-role="director" onclick="switchView('director-dashboard')">
            <span class="tab-icon">👥</span>
            <span class="tab-label">Director Dashboard</span>
          </button>
          <button class="nav-tab" data-view="cs-dashboard" data-required-role="csm" onclick="switchView('cs-dashboard')">
            <span class="tab-icon">🤝</span>
            <span class="tab-label">Customer Success</span>
          </button>
        </div>
      </nav>

      <!-- Timeline View (Original) -->
      <div id="timelineView" class="view-content">
        <div class="stats">
          <div class="stat-card">
            <div class="stat-label">Acciones totales</div>
            <div class="stat-value" id="totalActions">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Completadas</div>
            <div class="stat-value" id="completedActions">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Responsables</div>
            <div class="stat-value" id="totalResponsables">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Progreso global</div>
            <div class="stat-value" id="globalProgress">0%</div>
          </div>
        </div>
        <div class="timeline" id="timeline"></div>
      </div>

      <!-- User Dashboard View -->
      <div id="userDashboardView" class="view-content" style="display: none;">
        <div id="myDashboardContainer"></div>
      </div>

      <!-- CEO Dashboard View -->
      <div id="ceoDashboardView" class="view-content ceo-dashboard" style="display: none;">
        <!-- CEO Dashboard will be populated by JavaScript -->
      </div>

      <!-- Director Dashboard View -->
      <div id="directorDashboardView" class="view-content director-dashboard" style="display: none;">
        <!-- Director Dashboard will be populated by JavaScript -->
      </div>

      <!-- Customer Success Dashboard -->
      <div id="csDashboardView" class="view-content cs-dashboard" style="display: none;">
        <!-- CS Dashboard will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Onboarding Overlay -->
  <div id="onboardingOverlay" class="onboarding-overlay">
    <div class="onboarding-content">
      <div class="onboarding-header">
        <h2>¡Bienvenido a Nevent! 🚀</h2>
        <p>Tu plataforma de ejecución estratégica está lista</p>
      </div>

      <div class="onboarding-steps">
        <div class="onboarding-step">
          <div class="onboarding-step-icon">🎯</div>
          <div class="onboarding-step-content">
            <h3>Define tus OKRs</h3>
            <p>Crea objetivos medibles y alinéalos con los Key Results que realmente importan</p>
          </div>
        </div>

        <div class="onboarding-step">
          <div class="onboarding-step-icon">📋</div>
          <div class="onboarding-step-content">
            <h3>Planifica Iniciativas</h3>
            <p>Conecta tus proyectos con OKRs y gestiona presupuestos en tiempo real</p>
          </div>
        </div>

        <div class="onboarding-step">
          <div class="onboarding-step-icon">📈</div>
          <div class="onboarding-step-content">
            <h3>Ejecuta y Mide</h3>
            <p>Visualiza progreso en dashboards personalizados por rol y toma decisiones basadas en datos</p>
          </div>
        </div>
      </div>

      <div class="onboarding-footer">
        <button class="btn btn-secondary" onclick="skipOnboarding()">Saltar</button>
        <button class="btn btn-primary" onclick="completeOnboarding()">¡Empecemos!</button>
      </div>
    </div>
  </div>

  <div id="actionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Nueva Acción</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      
      <form id="actionForm" onsubmit="saveAction(event)">
        <div class="form-group">
          <label>Trimestre</label>
          <select id="quarterSelect" required>
            <option value="Q4 2025">Q4 2025</option>
            <option value="Q1 2026">Q1 2026</option>
            <option value="Q2 2026">Q2 2026</option>
            <option value="Q3 2026">Q3 2026</option>
            <option value="Q4 2026">Q4 2026</option>
          </select>
        </div>

        <div class="form-group">
          <label>Categoría</label>
          <select id="categorySelect" required>
            <option value="Marketing">Marketing</option>
            <option value="Customer Success">Customer Success</option>
            <option value="Expansión">Expansión</option>
            <option value="Producto">Producto</option>
            <option value="Ventas">Ventas</option>
            <option value="Operaciones">Operaciones</option>
          </select>
        </div>

        <div class="form-group">
          <label>Título</label>
          <input type="text" id="titleInput" placeholder="Ej: Email frío creativo" required />
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea id="descriptionInput" placeholder="Describe la acción..."></textarea>
        </div>

        <div class="form-group">
          <label>Prioridad</label>
          <select id="prioritySelect">
            <option value="Alta">Alta</option>
            <option value="Media">Media</option>
            <option value="Baja">Baja</option>
          </select>
        </div>

        <div class="form-group">
          <label>Estado</label>
          <select id="statusSelect">
            <option value="Pendiente">Pendiente</option>
            <option value="En curso">En curso</option>
            <option value="Completado">Completado</option>
          </select>
        </div>

        <div class="form-group">
          <label>Responsable</label>
          <input type="text" id="responsableInput" placeholder="Ej: Fran" />
        </div>

        <div class="form-group">
          <label>Vinculada a Initiative (opcional)</label>
          <select id="initiativeSelect">
            <option value="">Sin vincular</option>
          </select>
          <p style="color: var(--muted); font-size: 12px; margin-top: 4px;">
            Vincula esta acción a una initiative estratégica
          </p>
        </div>

        <div class="form-group">
          <label>Fecha límite</label>
          <input type="date" id="deadlineInput" />
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
          💾 Guardar
        </button>
      </form>
    </div>
  </div>

  <!-- Modal: Create User OKR -->
  <div id="okrModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">🎯 Nuevo OKR Personal</h2>
        <button class="close-btn" onclick="closeOKRModal()">&times;</button>
      </div>

      <form id="okrForm" onsubmit="saveOKR(event)">
        <div class="form-group">
          <label>Título del Objetivo</label>
          <input
            type="text"
            id="okrTitle"
            placeholder="Ej: Aumentar engagement en redes sociales"
            required
          />
        </div>

        <div class="form-group">
          <label>Trimestre</label>
          <select id="okrQuarter" required>
            <option value="Q4 2025">Q4 2025</option>
            <option value="Q1 2026">Q1 2026</option>
            <option value="Q2 2026">Q2 2026</option>
            <option value="Q3 2026">Q3 2026</option>
            <option value="Q4 2026">Q4 2026</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fecha límite</label>
          <input type="date" id="okrDeadline" required />
        </div>

        <div class="form-group">
          <label>Key Results (Resultados Clave)</label>
          <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
            Define 2-5 resultados medibles para alcanzar este objetivo
          </p>
          <div id="keyResultsContainer"></div>
          <button type="button" class="btn btn-secondary" onclick="addKeyResult()" style="width: 100%; margin-top: 8px;">
            ➕ Agregar Key Result
          </button>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
          💾 Crear OKR
        </button>
      </form>
    </div>
  </div>

  <!-- Modal: Create Initiative -->
  <div id="initiativeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">🚀 Nueva Initiative</h2>
        <button class="close-btn" onclick="closeInitiativeModal()">&times;</button>
      </div>

      <form id="initiativeForm" onsubmit="saveInitiative(event)">
        <div class="form-group">
          <label>Título de la Initiative</label>
          <input
            type="text"
            id="initiativeTitle"
            placeholder="Ej: Campaña de Content Marketing Q4"
            required
          />
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea
            id="initiativeDescription"
            placeholder="Describe el proyecto y su objetivo..."
            rows="3"
          ></textarea>
        </div>

        <div class="form-group">
          <label>Contribuye al OKR</label>
          <select id="initiativeOKR">
            <option value="">Sin vincular</option>
          </select>
          <p style="color: var(--muted); font-size: 12px; margin-top: 4px;">
            Vincula esta initiative a uno de tus OKRs
          </p>
        </div>

        <div class="form-group">
          <label>Trimestre</label>
          <select id="initiativeQuarter" required>
            <option value="Q4 2025">Q4 2025</option>
            <option value="Q1 2026">Q1 2026</option>
            <option value="Q2 2026">Q2 2026</option>
            <option value="Q3 2026">Q3 2026</option>
            <option value="Q4 2026">Q4 2026</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fechas</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label style="font-size: 13px; color: var(--muted);">Inicio</label>
              <input type="date" id="initiativeStartDate" required style="margin-top: 4px;" />
            </div>
            <div>
              <label style="font-size: 13px; color: var(--muted);">Fin</label>
              <input type="date" id="initiativeEndDate" required style="margin-top: 4px;" />
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Budget Asignado (€)</label>
          <input
            type="number"
            id="initiativeBudget"
            placeholder="25000"
            min="0"
            step="100"
          />
        </div>

        <div class="form-group">
          <label>Estado Inicial</label>
          <select id="initiativeStatus">
            <option value="not_started">No iniciado</option>
            <option value="in_progress" selected>En progreso</option>
            <option value="on_hold">En pausa</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
          💾 Crear Initiative
        </button>
      </form>
    </div>
  </div>

  <!-- Modal: Create Company OKR -->
  <div id="companyOKRModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">🌍 Nuevo OKR de Empresa</h2>
        <button class="close-btn" onclick="closeCompanyOKRModal()">&times;</button>
      </div>

      <form id="companyOKRForm" onsubmit="saveCompanyOKR(event)">
        <div class="form-group">
          <label>Objetivo Estratégico</label>
          <input
            type="text"
            id="companyOKRObjective"
            placeholder="Ej: Convertirse en la plataforma #1 de eventos en España"
            required
          />
          <p style="color: var(--muted); font-size: 12px; margin-top: 4px;">
            Define el objetivo principal de la empresa para este año
          </p>
        </div>

        <div class="form-group">
          <label>Año Fiscal</label>
          <select id="companyOKRYear" required>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
          </select>
        </div>

        <div class="form-group">
          <label>Key Results (Resultados Clave)</label>
          <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">
            Define 3-5 resultados medibles a nivel empresa
          </p>
          <div id="companyKeyResultsContainer"></div>
          <button type="button" class="btn btn-secondary" onclick="addCompanyKeyResult()" style="width: 100%; margin-top: 8px;">
            ➕ Agregar Key Result
          </button>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
          💾 Crear OKR de Empresa
        </button>
      </form>
    </div>
  </div>

  <!-- Modal: Confirmation Dialog -->
  <div id="confirmDialog" class="modal">
    <div class="modal-content" style="max-width: 480px;">
      <div class="modal-header">
        <h2 class="modal-title" id="confirmDialogTitle">⚠️ Confirmar acción</h2>
      </div>
      <div class="modal-body">
        <p id="confirmDialogMessage" style="font-size: 16px; margin-bottom: 12px; color: var(--ink);"></p>
        <p id="confirmDialogDetails" style="font-size: 14px; color: var(--muted);"></p>
      </div>
      <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
        <button type="button" class="btn btn-secondary" id="confirmDialogCancel">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmDialogConfirm">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Customer Management -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="customerModalTitle">🤝 Nuevo Cliente</h2>
        <button class="close-btn" onclick="closeCustomerModal()">&times;</button>
      </div>

      <form id="customerForm" onsubmit="saveCustomer(event)">
        <input type="hidden" id="customerEditId" />

        <div class="form-group">
          <label>Nombre del Cliente *</label>
          <input
            type="text"
            id="customerName"
            placeholder="Ej: Acme Corporation"
            required
          />
        </div>

        <div class="form-group">
          <label>CRM ID</label>
          <input
            type="text"
            id="customerCrmId"
            placeholder="ID en tu CRM (opcional)"
          />
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label>MRR (€/mes) *</label>
            <input
              type="number"
              id="customerMrr"
              placeholder="500"
              step="0.01"
              min="0"
              required
            />
          </div>

          <div class="form-group">
            <label>Estado *</label>
            <select id="customerStatus" required>
              <option value="prospect">🔍 Prospecto</option>
              <option value="active" selected>✅ Activo</option>
              <option value="churned">❌ Churned</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Customer Success Manager</label>
          <select id="customerCsm">
            <option value="">Sin asignar</option>
            <!-- Will be populated dynamically -->
          </select>
        </div>

        <div class="form-group">
          <label>Onboarding Completado</label>
          <div style="display: flex; align-items: center; gap: 12px;">
            <input type="checkbox" id="customerOnboardingCompleted" style="width: auto; cursor: pointer;" />
            <label for="customerOnboardingCompleted" style="margin: 0; cursor: pointer; color: var(--muted); font-size: 14px;">
              Cliente ha completado el proceso de onboarding
            </label>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label>Fecha Primera Evento</label>
            <input type="date" id="customerFirstEventDate" />
          </div>

          <div class="form-group">
            <label>Último QBR</label>
            <input type="date" id="customerLastQbr" />
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label>Eventos Creados</label>
            <input type="number" id="customerEventsCreated" placeholder="0" min="0" value="0" />
          </div>

          <div class="form-group">
            <label>Total Asistentes</label>
            <input type="number" id="customerTotalAttendees" placeholder="0" min="0" value="0" />
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label>% Activación (0-100)</label>
            <input type="number" id="customerActivationPercent" placeholder="0" min="0" max="100" value="0" />
          </div>

          <div class="form-group">
            <label>Health Score (0-100)</label>
            <input type="number" id="customerHealthScore" placeholder="50" min="0" max="100" value="50" />
            <p style="color: var(--muted); font-size: 12px; margin-top: 4px;">
              Se calculará automáticamente si se deja en 50
            </p>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
          💾 Guardar Cliente
        </button>
      </form>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://tvbqzqripcevaryquhfg.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2YnF6cXJpcGNldmFyeXF1aGZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNTI4MzEsImV4cCI6MjA3NDcyODgzMX0.BVHINkyJtK4mwRLX1Nt7_gJbd3ht2qGfvqLvmehkyIM';

    let supabase;
    let currentUser = null;
    let currentUserRole = null;
    let myOKRs = [];
    let myInitiatives = [];
    let allDepartments = [];
    let isDashboardVisible = false;

    // ============================================
    // ANALYTICS SYSTEM
    // ============================================
    const analytics = {
      sessionId: `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      events: [],

      track(eventName, properties = {}) {
        const event = {
          id: `evt-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          name: eventName,
          timestamp: new Date().toISOString(),
          session_id: this.sessionId,
          user_id: currentUser?.id || 'anonymous',
          user_email: currentUser?.email || 'anonymous',
          user_role: currentUser?.role || 'unknown',
          properties: {
            ...properties,
            url: window.location.href,
            viewport_width: window.innerWidth,
            viewport_height: window.innerHeight
          }
        };

        this.events.push(event);

        // Console log en desarrollo
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log('📊 Analytics:', eventName, properties);
        }

        // Guardar en localStorage para análisis posterior
        this.persistEvent(event);

        return event;
      },

      persistEvent(event) {
        try {
          const storedEvents = JSON.parse(localStorage.getItem('analytics_events') || '[]');
          storedEvents.push(event);

          // Keep only last 100 events
          if (storedEvents.length > 100) {
            storedEvents.shift();
          }

          localStorage.setItem('analytics_events', JSON.stringify(storedEvents));
        } catch (error) {
          console.error('Error persisting analytics event:', error);
        }
      },

      getEvents(filters = {}) {
        try {
          const events = JSON.parse(localStorage.getItem('analytics_events') || '[]');

          if (filters.eventName) {
            return events.filter(e => e.name === filters.eventName);
          }

          if (filters.sessionId) {
            return events.filter(e => e.session_id === filters.sessionId);
          }

          return events;
        } catch (error) {
          console.error('Error getting analytics events:', error);
          return [];
        }
      },

      clearEvents() {
        localStorage.removeItem('analytics_events');
        this.events = [];
      }
    };

    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (error) {
      showToast('Error al inicializar la conexión con el servidor', 'error');
    }

    async function handleLogin(event) {
      event.preventDefault();

      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      const errorDiv = document.getElementById('loginError');

      errorDiv.classList.remove('show');
      errorDiv.textContent = '';

      await withButtonLoading(loginBtn, async () => {
        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
          });

          if (error) throw error;

          currentUser = data.user;

          // Load user profile from public.users table to get role
          const { data: userProfile, error: profileError } = await supabase
            .from('users')
            .select('*')
            .eq('id', data.user.id)
            .single();

          if (userProfile) {
            // Merge profile data with auth user
            currentUser.role = userProfile.role;
            currentUser.full_name = userProfile.full_name;
            currentUser.department_id = userProfile.department_id;
          } else {
            // Fallback to user_metadata if no profile exists
            currentUser.role = data.user.user_metadata?.role || 'user';
          }

          // Track login
          analytics.track('user_login', {
            role: currentUser.role,
            has_profile: !!userProfile
          });

          document.getElementById('loginPage').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';

          await loadData();
          await loadMyOKRs();
          await loadMyInitiatives();
          await loadDepartments();
          initializeRoleBasedNav();
          await initializeViewAsSystem();
          setupRealtimeSync();

          // Show onboarding for first-time users
          checkAndShowOnboarding();

        } catch (error) {
          errorDiv.textContent = error.message || 'Error al iniciar sesión. Verifica tus credenciales.';
          errorDiv.classList.add('show');
          throw error; // Re-throw to handle in finally
        }
      });
    }

    async function handleLogout() {
      try {
        await supabase.auth.signOut();
        currentUser = null;
        currentUserRole = null;
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
      } catch (error) {
        showToast('Error al cerrar sesión', 'error');
      }
    }

    // ==================================================================
    // ONBOARDING FUNCTIONS
    // ==================================================================

    function checkAndShowOnboarding() {
      const hasSeenOnboarding = localStorage.getItem('onboarding_completed');

      if (!hasSeenOnboarding) {
        // Small delay for better UX (let dashboard load first)
        setTimeout(() => {
          document.getElementById('onboardingOverlay').classList.add('active');
          analytics.track('onboarding_shown', {
            user_role: currentUser?.role
          });
        }, 500);
      }
    }

    function completeOnboarding() {
      localStorage.setItem('onboarding_completed', 'true');
      document.getElementById('onboardingOverlay').classList.remove('active');

      analytics.track('onboarding_completed', {
        user_role: currentUser?.role
      });

      // Show welcome toast
      showToast(
        `¡Bienvenido/a ${currentUser?.full_name || 'a la plataforma'}! 🎉`,
        'success',
        '¡Todo listo!',
        8000
      );
    }

    function skipOnboarding() {
      localStorage.setItem('onboarding_completed', 'true');
      document.getElementById('onboardingOverlay').classList.remove('active');

      analytics.track('onboarding_skipped', {
        user_role: currentUser?.role
      });
    }

    // Reset onboarding for testing (call from console)
    function resetOnboarding() {
      localStorage.removeItem('onboarding_completed');
      console.log('Onboarding reset. Refresh page to see it again.');
    }

    // ==================================================================
    // TOOLTIP HELPERS
    // ==================================================================

    /**
     * Create tooltip HTML for complex metrics
     * @param {string} label - Metric label
     * @param {string} title - Tooltip title
     * @param {string} description - Tooltip description
     * @param {string} formula - Optional formula
     * @returns {string} HTML string with tooltip
     */
    function createTooltip(label, title, description, formula = null) {
      return `
        <span class="tooltip-trigger">
          <span>${sanitizeHTML(label)}</span>
          <span class="tooltip-icon">?</span>
          <div class="tooltip-content">
            <div class="tooltip-title">${sanitizeHTML(title)}</div>
            <div class="tooltip-text">${sanitizeHTML(description)}</div>
            ${formula ? `<div class="tooltip-formula">${sanitizeHTML(formula)}</div>` : ''}
          </div>
        </span>
      `;
    }

    // Metric tooltips definitions
    const METRIC_TOOLTIPS = {
      nrr: {
        title: 'Net Revenue Retention (NRR)',
        description: 'Mide el crecimiento de ingresos de clientes existentes. >100% significa que los upsells superan el churn.',
        formula: 'NRR = ((Ingresos Iniciales + Expansión - Contracción - Churn) / Ingresos Iniciales) × 100'
      },
      churn: {
        title: 'Tasa de Churn',
        description: 'Porcentaje de clientes que cancelan en un período. <5% anual es excelente para B2B SaaS.',
        formula: 'Churn = (Clientes Perdidos / Clientes Iniciales) × 100'
      },
      health_score: {
        title: 'Health Score',
        description: 'Indicador de salud del cliente basado en engagement, uso del producto y pago. 0-100 escala.',
        formula: 'Health = (Onboarding × 0.3) + (Eventos × 0.3) + (Activación × 0.2) + (MRR × 0.2)'
      },
      arr: {
        title: 'Annual Recurring Revenue (ARR)',
        description: 'Ingresos recurrentes anualizados. Métrica clave para SaaS B2B.',
        formula: 'ARR = MRR × 12'
      },
      mrr: {
        title: 'Monthly Recurring Revenue (MRR)',
        description: 'Ingresos recurrentes mensuales predecibles. Base del crecimiento SaaS.',
        formula: 'MRR = Σ (Precio Suscripción × Número Clientes)'
      }
    };

    async function checkSession() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
          currentUser = session.user;

          // Load user profile from public.users table to get role
          const { data: userProfile } = await supabase
            .from('users')
            .select('*')
            .eq('id', session.user.id)
            .single();

          if (userProfile) {
            currentUser.role = userProfile.role;
            currentUser.full_name = userProfile.full_name;
            currentUser.department_id = userProfile.department_id;
          } else {
            currentUser.role = session.user.user_metadata?.role || 'user';
          }

          document.getElementById('loginPage').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          await loadData();
          await loadMyOKRs();
          await loadMyInitiatives();
          await loadDepartments();
          initializeRoleBasedNav();
          await initializeViewAsSystem();
          setupRealtimeSync();
        }
      } catch (error) {
        // Silent fail on session check - user will see login page
      }
    }

    let roadmapData = {
      quarters: {
        'Q4 2025': [],
        'Q1 2026': [],
        'Q2 2026': [],
        'Q3 2026': [],
        'Q4 2026': []
      }
    };

    let editingAction = null;

    function generateId() {
      return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    async function loadData() {
      try {
        const { data, error } = await supabase
          .from('roadmap_actions')
          .select('*')
          .order('created_at', { ascending: true });

        if (error) throw error;

        roadmapData.quarters = {
          'Q4 2025': [],
          'Q1 2026': [],
          'Q2 2026': [],
          'Q3 2026': [],
          'Q4 2026': []
        };

        if (data) {
          data.forEach(item => {
            if (roadmapData.quarters[item.quarter]) {
              roadmapData.quarters[item.quarter].push(item);
            }
          });
        }

        renderTimeline();
        updateStats();
      } catch (error) {
        handleSupabaseError(error, 'cargar datos');
      }
    }

    async function saveToSupabase(action, quarter) {
      try {
        const { error } = await supabase
          .from('roadmap_actions')
          .upsert({
            id: action.id,
            quarter: quarter,
            category: action.category,
            title: action.title,
            description: action.description || '',
            priority: action.priority,
            status: action.status,
            responsable: action.responsable || '',
            deadline: action.deadline || null,
            subtasks: action.subtasks || [],
            updated_at: new Date().toISOString()
          }, { onConflict: 'id' });

        if (error) throw error;
      } catch (error) {
        handleSupabaseError(error, 'guardar');
        throw error;
      }
    }

    async function deleteFromSupabase(actionId) {
      try {
        const { error } = await supabase
          .from('roadmap_actions')
          .delete()
          .eq('id', actionId);

        if (error) throw error;
      } catch (error) {
        handleSupabaseError(error, 'eliminar');
      }
    }

    function setupRealtimeSync() {
      supabase
        .channel('roadmap_changes')
        .on('postgres_changes', { 
          event: '*', 
          schema: 'public', 
          table: 'roadmap_actions'
        }, payload => {
          loadData();
        })
        .subscribe();
    }

    async function syncData() {
      try {
        await loadData();
        showToast('Datos sincronizados exitosamente', 'success');
      } catch (error) {
        handleSupabaseError(error, 'sincronizar datos');
      }
    }

    function renderTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '';

      Object.keys(roadmapData.quarters).forEach(quarter => {
        const actions = roadmapData.quarters[quarter];
        
        const quarterDiv = document.createElement('div');
        quarterDiv.className = 'quarter';
        quarterDiv.innerHTML = `
          <div class="quarter-header">
            <h2 class="quarter-title">${quarter}</h2>
            <span style="color: var(--muted);">${actions.length} acciones</span>
          </div>
          <div class="actions-grid" id="actions-${quarter}"></div>
        `;
        
        timeline.appendChild(quarterDiv);

        const actionsGrid = document.getElementById(`actions-${quarter}`);
        
        actions.forEach(action => {
          const actionCard = document.createElement('div');
          actionCard.className = 'action-card';
          // Sanitize user-controlled content to prevent XSS
          safeSetHTML(actionCard, `
            <div class="action-header">
              <div>
                <div class="action-title">${sanitizeHTML(action.title)}</div>
                <span class="action-category">${sanitizeHTML(action.category)}</span>
              </div>
              <span class="status-badge status-${action.status.replace(' ', '.')}">${sanitizeHTML(action.status)}</span>
            </div>

            ${action.description ? `<p style="color: var(--muted); font-size: 14px; margin: 8px 0;">${sanitizeHTML(action.description)}</p>` : ''}

            <div class="action-meta">
              <span class="priority-badge priority-${action.priority}">
                ${action.priority === 'Alta' ? '🔴' : action.priority === 'Media' ? '🟡' : '🟢'} ${sanitizeHTML(action.priority)}
              </span>
              ${action.responsable ? `<span>👤 ${sanitizeHTML(action.responsable)}</span>` : ''}
              ${action.deadline ? `<span>📅 ${sanitizeHTML(action.deadline)}</span>` : ''}
            </div>

            ${action.subtasks && action.subtasks.length > 0 ? `
              <div class="subtasks">
                ${action.subtasks.map(st => `
                  <div class="subtask">
                    <input
                      type="checkbox"
                      ${st.completed ? 'checked' : ''}
                      onchange="toggleSubtask('${action.id}', '${st.id}', '${quarter}')"
                    />
                    <span style="${st.completed ? 'text-decoration: line-through; color: var(--muted);' : ''}">${sanitizeHTML(st.text)}</span>
                  </div>
                `).join('')}
              </div>
            ` : ''}

            <div class="action-buttons">
              <button onclick="editAction('${action.id}', '${quarter}')">✏️ Editar</button>
              <button onclick="deleteAction('${action.id}', '${quarter}')">🗑️ Eliminar</button>
            </div>
          `);
          
          actionsGrid.appendChild(actionCard);
        });
      });
    }

    function updateStats() {
      let total = 0;
      let completed = 0;
      let responsables = new Set();

      Object.values(roadmapData.quarters).forEach(actions => {
        total += actions.length;
        actions.forEach(action => {
          if (action.status === 'Completado') completed++;
          if (action.responsable) responsables.add(action.responsable);
        });
      });

      document.getElementById('totalActions').textContent = total;
      document.getElementById('completedActions').textContent = completed;
      document.getElementById('totalResponsables').textContent = responsables.size;
      document.getElementById('globalProgress').textContent = total > 0 ? Math.round((completed / total) * 100) + '%' : '0%';
    }

    function openAddActionModal() {
      editingAction = null;
      document.getElementById('modalTitle').textContent = 'Nueva Acción';
      document.getElementById('actionForm').reset();
      populateInitiativeDropdown();
      document.getElementById('actionModal').classList.add('active');
    }

    function populateInitiativeDropdown() {
      const select = document.getElementById('initiativeSelect');
      select.innerHTML = '<option value="">Sin vincular</option>';

      myInitiatives.forEach(initiative => {
        const option = document.createElement('option');
        option.value = initiative.id;
        option.textContent = `${initiative.title} (${initiative.quarter})`;
        select.appendChild(option);
      });
    }

    function editAction(actionId, quarter) {
      const action = roadmapData.quarters[quarter].find(a => a.id === actionId);
      if (!action) return;

      editingAction = { action, quarter };
      document.getElementById('modalTitle').textContent = 'Editar Acción';

      document.getElementById('quarterSelect').value = quarter;
      document.getElementById('categorySelect').value = action.category;
      document.getElementById('titleInput').value = action.title;
      document.getElementById('descriptionInput').value = action.description || '';
      document.getElementById('prioritySelect').value = action.priority;
      document.getElementById('statusSelect').value = action.status;
      document.getElementById('responsableInput').value = action.responsable || '';
      document.getElementById('deadlineInput').value = action.deadline || '';

      populateInitiativeDropdown();
      document.getElementById('initiativeSelect').value = action.initiative_id || '';

      document.getElementById('actionModal').classList.add('active');
    }

    async function saveAction(event) {
      event.preventDefault();

      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');

      const quarter = document.getElementById('quarterSelect').value;
      const initiative_id = document.getElementById('initiativeSelect').value || null;

      const actionData = {
        id: editingAction ? editingAction.action.id : generateId(),
        category: document.getElementById('categorySelect').value,
        title: document.getElementById('titleInput').value,
        description: document.getElementById('descriptionInput').value,
        priority: document.getElementById('prioritySelect').value,
        status: document.getElementById('statusSelect').value,
        responsable: document.getElementById('responsableInput').value,
        deadline: document.getElementById('deadlineInput').value,
        initiative_id: initiative_id,
        subtasks: editingAction ? editingAction.action.subtasks : []
      };

      await withButtonLoading(submitBtn, async () => {
        if (editingAction) {
          const oldQuarter = editingAction.quarter;
          roadmapData.quarters[oldQuarter] = roadmapData.quarters[oldQuarter].filter(a => a.id !== actionData.id);
        }

        roadmapData.quarters[quarter].push(actionData);
        await saveToSupabase(actionData, quarter);

        closeModal();
        renderTimeline();
        updateStats();

        // Update initiative progress if linked
        if (initiative_id) {
          await updateInitiativeProgress(initiative_id);
        }
      });
    }

    async function deleteAction(actionId, quarter) {
      // Get action title for confirmation
      const action = roadmapData.quarters[quarter]?.find(a => a.id === actionId);
      const actionTitle = action?.title || 'esta acción';

      const confirmed = await showConfirmDialog({
        title: '⚠️ Confirmar eliminación',
        message: `¿Estás seguro de eliminar "${actionTitle}"?`,
        details: 'Esta acción no se puede deshacer. Se eliminarán todas las subtareas asociadas.',
        confirmText: 'Sí, eliminar',
        cancelText: 'Cancelar',
        danger: true
      });

      if (!confirmed) return;

      roadmapData.quarters[quarter] = roadmapData.quarters[quarter].filter(a => a.id !== actionId);
      await deleteFromSupabase(actionId);

      renderTimeline();
      updateStats();
    }

    async function toggleSubtask(actionId, subtaskId, quarter) {
      const action = roadmapData.quarters[quarter].find(a => a.id === actionId);
      if (!action) return;

      const subtask = action.subtasks.find(st => st.id === subtaskId);
      if (subtask) {
        subtask.completed = !subtask.completed;

        const allCompleted = action.subtasks.every(st => st.completed);
        const someCompleted = action.subtasks.some(st => st.completed);

        if (allCompleted) {
          action.status = 'Completado';
        } else if (someCompleted) {
          action.status = 'En curso';
        } else {
          action.status = 'Pendiente';
        }

        await saveToSupabase(action, quarter);
        renderTimeline();
        updateStats();
      }
    }

    function closeModal() {
      document.getElementById('actionModal').classList.remove('active');
    }

    // OKR Modal Functions
    let keyResultCounter = 0;

    function openOKRModal() {
      document.getElementById('okrModal').classList.add('active');
      document.getElementById('okrForm').reset();
      document.getElementById('keyResultsContainer').innerHTML = '';
      keyResultCounter = 0;
      // Add initial key result
      addKeyResult();
      addKeyResult();
    }

    function closeOKRModal() {
      document.getElementById('okrModal').classList.remove('active');
    }

    function addKeyResult() {
      const container = document.getElementById('keyResultsContainer');
      const krId = `kr-${keyResultCounter++}`;

      const krHTML = `
        <div class="key-result-item" id="kr-item-${krId}" style="border: 1px solid var(--stroke); border-radius: 8px; padding: 16px; margin-bottom: 12px; background: var(--bg);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <strong style="color: var(--accent1);">KR ${keyResultCounter}</strong>
            <button type="button" onclick="removeKeyResult('${krId}')" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 18px;">×</button>
          </div>

          <div style="margin-bottom: 8px;">
            <label style="font-size: 13px; color: var(--muted);">Descripción</label>
            <input type="text" class="kr-description" placeholder="Ej: Alcanzar 50K seguidores en LinkedIn" required style="width: 100%; padding: 8px; background: var(--card); border: 1px solid var(--stroke); border-radius: 4px; color: var(--ink); margin-top: 4px;" />
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
            <div>
              <label style="font-size: 13px; color: var(--muted);">Actual</label>
              <input type="number" class="kr-current" placeholder="0" value="0" required style="width: 100%; padding: 8px; background: var(--card); border: 1px solid var(--stroke); border-radius: 4px; color: var(--ink); margin-top: 4px;" />
            </div>
            <div>
              <label style="font-size: 13px; color: var(--muted);">Meta</label>
              <input type="number" class="kr-target" placeholder="100" required style="width: 100%; padding: 8px; background: var(--card); border: 1px solid var(--stroke); border-radius: 4px; color: var(--ink); margin-top: 4px;" />
            </div>
            <div>
              <label style="font-size: 13px; color: var(--muted);">Unidad</label>
              <input type="text" class="kr-unit" placeholder="seguidores" required style="width: 100%; padding: 8px; background: var(--card); border: 1px solid var(--stroke); border-radius: 4px; color: var(--ink); margin-top: 4px;" />
            </div>
          </div>
        </div>
      `;

      container.insertAdjacentHTML('beforeend', krHTML);
    }

    function removeKeyResult(krId) {
      const element = document.getElementById(`kr-item-${krId}`);
      if (element) {
        element.remove();
      }
    }

    async function saveOKR(event) {
      event.preventDefault();

      if (!currentUser) {
        showToast('Debes iniciar sesión para crear un OKR', 'warning');
        return;
      }

      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');

      const title = document.getElementById('okrTitle').value;
      const quarter = document.getElementById('okrQuarter').value;
      const deadline = document.getElementById('okrDeadline').value;

      // Collect all key results
      const krItems = document.querySelectorAll('.key-result-item');
      const keyResults = [];

      krItems.forEach((item, index) => {
        const description = item.querySelector('.kr-description').value;
        const current = parseFloat(item.querySelector('.kr-current').value) || 0;
        const target = parseFloat(item.querySelector('.kr-target').value) || 0;
        const unit = item.querySelector('.kr-unit').value;

        if (description && target > 0) {
          const progress = target > 0 ? Math.round((current / target) * 100) : 0;
          keyResults.push({
            id: `kr-${index + 1}`,
            description,
            current,
            target,
            unit,
            progress
          });
        }
      });

      if (keyResults.length < 2) {
        showToast('Debes agregar al menos 2 Key Results', 'warning');
        return;
      }

      // Calculate overall progress
      const avgProgress = Math.round(
        keyResults.reduce((sum, kr) => sum + kr.progress, 0) / keyResults.length
      );

      // Determine status based on progress
      let status = 'not_started';
      if (avgProgress === 0) status = 'not_started';
      else if (avgProgress < 40) status = 'off_track';
      else if (avgProgress < 70) status = 'at_risk';
      else if (avgProgress < 100) status = 'on_track';
      else status = 'completed';

      const newOKR = {
        id: generateId(),
        user_id: currentUser.id,
        title,
        quarter,
        key_results: keyResults,
        progress: avgProgress,
        status,
        deadline,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      await withButtonLoading(submitBtn, async () => {
        try {
          const { error } = await supabase
            .from('user_okrs')
            .insert([newOKR]);

          if (error) throw error;

          closeOKRModal();
          await loadMyOKRs();
          if (isDashboardVisible) {
            await renderMyDashboard();
          }
          showToast('OKR creado exitosamente', 'success');
        } catch (error) {
          handleSupabaseError(error, 'crear OKR');
          throw error;
        }
      });
    }

    // Company OKR Modal Functions
    let companyKeyResultCounter = 0;

    function openCompanyOKRModal() {
      document.getElementById('companyOKRModal').classList.add('active');
      document.getElementById('companyOKRForm').reset();
      document.getElementById('companyKeyResultsContainer').innerHTML = '';
      companyKeyResultCounter = 0;

      // Company OKRs typically have 3-5 key results, start with 3
      addCompanyKeyResult();
      addCompanyKeyResult();
      addCompanyKeyResult();
    }

    function closeCompanyOKRModal() {
      document.getElementById('companyOKRModal').classList.remove('active');
    }

    function addCompanyKeyResult() {
      const container = document.getElementById('companyKeyResultsContainer');
      const krId = ++companyKeyResultCounter;

      const krDiv = document.createElement('div');
      krDiv.className = 'key-result-item';
      krDiv.innerHTML = `
        <div class="kr-header">
          <label>Key Result ${krId}</label>
          ${krId > 3 ? `<button type="button" class="remove-kr-btn" onclick="removeCompanyKeyResult(${krId})">✕</button>` : ''}
        </div>
        <input
          type="text"
          id="companyKR${krId}"
          placeholder="Ej: Aumentar ARR de €2M a €5M"
          required
        />
        <div class="kr-metrics">
          <input
            type="number"
            id="companyKRCurrent${krId}"
            placeholder="Valor actual"
            step="0.01"
            required
          />
          <input
            type="number"
            id="companyKRTarget${krId}"
            placeholder="Objetivo"
            step="0.01"
            required
          />
          <input
            type="text"
            id="companyKRUnit${krId}"
            placeholder="Unidad (EUR, %, clientes...)"
            required
          />
        </div>
      `;

      container.appendChild(krDiv);

      // Limit to 5 key results
      if (companyKeyResultCounter >= 5) {
        const addButton = document.querySelector('#companyOKRForm .btn-secondary');
        if (addButton) addButton.style.display = 'none';
      }
    }

    function removeCompanyKeyResult(krId) {
      const krItem = document.querySelector(`#companyKR${krId}`).closest('.key-result-item');
      if (krItem) {
        krItem.remove();
        companyKeyResultCounter--;

        // Show add button again if under limit
        const addButton = document.querySelector('#companyOKRForm .btn-secondary');
        if (addButton && companyKeyResultCounter < 5) {
          addButton.style.display = 'inline-block';
        }
      }
    }

    async function saveCompanyOKR(event) {
      event.preventDefault();

      if (!currentUser) {
        showToast('Debes iniciar sesión para crear un OKR de empresa', 'warning');
        return;
      }

      // Verify CEO role
      if (currentUser.role !== 'ceo') {
        showToast('Solo CEOs pueden crear OKRs de empresa', 'error');
        return;
      }

      const objective = document.getElementById('companyOKRObjective').value;
      const fiscal_year = document.getElementById('companyOKRYear').value;

      // Collect key results
      const key_results = [];
      let totalProgress = 0;

      for (let i = 1; i <= companyKeyResultCounter; i++) {
        const descInput = document.getElementById(`companyKR${i}`);
        if (descInput && descInput.value) {
          const current = parseFloat(document.getElementById(`companyKRCurrent${i}`).value) || 0;
          const target = parseFloat(document.getElementById(`companyKRTarget${i}`).value) || 1;
          const unit = document.getElementById(`companyKRUnit${i}`).value;

          const progress = Math.min(Math.round((current / target) * 100), 100);
          totalProgress += progress;

          key_results.push({
            id: `kr-${i}`,
            description: descInput.value,
            current,
            target,
            unit,
            progress
          });
        }
      }

      // Validate minimum 3 key results for company OKRs
      if (key_results.length < 3) {
        showToast('Los OKRs de empresa deben tener al menos 3 Key Results', 'warning');
        return;
      }

      // Calculate health score
      const avgProgress = Math.round(totalProgress / key_results.length);
      const health_score = avgProgress;

      const newCompanyOKR = {
        id: generateId(),
        fiscal_year,
        objective,
        key_results,
        health_score,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');

      await withButtonLoading(submitBtn, async () => {
        try {
          const { data, error } = await supabase
            .from('company_okrs')
            .insert([newCompanyOKR])
            .select();

          if (error) throw error;

          showToast(`OKR de empresa creado exitosamente: ${objective}`, 'success');
          closeCompanyOKRModal();

          // Refresh CEO dashboard if we're on it
          if (currentView === 'ceo-dashboard') {
            renderCEODashboard();
          }
        } catch (error) {
          handleSupabaseError(error, 'crear OKR de empresa');
          throw error;
        }
      });
    }

    // Initiative Modal Functions
    function openInitiativeModal() {
      document.getElementById('initiativeModal').classList.add('active');
      document.getElementById('initiativeForm').reset();
      populateOKRDropdown();
    }

    function closeInitiativeModal() {
      document.getElementById('initiativeModal').classList.remove('active');
    }

    function populateOKRDropdown() {
      const select = document.getElementById('initiativeOKR');
      select.innerHTML = '<option value="">Sin vincular</option>';

      myOKRs.forEach(okr => {
        const option = document.createElement('option');
        option.value = okr.id;
        option.textContent = `${okr.title} (${okr.quarter})`;
        select.appendChild(option);
      });
    }

    async function saveInitiative(event) {
      event.preventDefault();

      if (!currentUser) {
        showToast('Debes iniciar sesión para crear una Initiative', 'warning');
        return;
      }

      const title = document.getElementById('initiativeTitle').value;
      const description = document.getElementById('initiativeDescription').value;
      const contributes_to_okr = document.getElementById('initiativeOKR').value || null;
      const quarter = document.getElementById('initiativeQuarter').value;
      const start_date = document.getElementById('initiativeStartDate').value;
      const end_date = document.getElementById('initiativeEndDate').value;
      const budget_allocated = parseFloat(document.getElementById('initiativeBudget').value) || 0;
      const status = document.getElementById('initiativeStatus').value;

      const newInitiative = {
        id: generateId(),
        title,
        description,
        owner_id: currentUser.id,
        contributes_to_okr,
        quarter,
        start_date,
        end_date,
        status,
        progress: 0,
        health: 'on_track',
        budget_allocated,
        budget_spent: 0,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');

      await withButtonLoading(submitBtn, async () => {
        try {
          const { error } = await supabase
            .from('initiatives')
            .insert([newInitiative]);

          if (error) throw error;

          closeInitiativeModal();
          await loadMyInitiatives();
          if (isDashboardVisible) {
            await renderMyDashboard();
          }
          showToast('Initiative creada exitosamente', 'success');
        } catch (error) {
          handleSupabaseError(error, 'crear Initiative');
          throw error;
        }
      });
    }

    // Auto-calculate Initiative Progress from Actions
    async function updateInitiativeProgress(initiativeId) {
      try {
        // Get all actions linked to this initiative
        const { data: actions, error } = await supabase
          .from('roadmap_actions')
          .select('status')
          .eq('initiative_id', initiativeId);

        if (error) throw error;

        if (!actions || actions.length === 0) {
          return;
        }

        // Calculate progress based on action status
        const totalActions = actions.length;
        const completedActions = actions.filter(a => a.status === 'Completado').length;
        const inProgressActions = actions.filter(a => a.status === 'En curso').length;

        // Progress formula: completed = 100%, in_progress = 50%, pending = 0%
        const progress = Math.round(
          ((completedActions * 100) + (inProgressActions * 50)) / totalActions
        );

        // Determine health based on progress
        let health = 'on_track';
        if (progress < 40) health = 'off_track';
        else if (progress < 70) health = 'at_risk';
        else health = 'on_track';

        // Update initiative
        const { error: updateError } = await supabase
          .from('initiatives')
          .update({
            progress,
            health,
            updated_at: new Date().toISOString()
          })
          .eq('id', initiativeId);

        if (updateError) throw updateError;

        // Reload initiatives if dashboard is visible
        if (isDashboardVisible) {
          await loadMyInitiatives();
          await renderMyDashboard();
        }
      } catch (error) {
        handleSupabaseError(error, 'actualizar progreso de initiative');
      }
    }

    // Customer Management Functions
    let allCustomers = [];
    let allCsmUsers = [];

    function openCustomerModal(customerId = null) {
      const modal = document.getElementById('customerModal');
      const form = document.getElementById('customerForm');
      const title = document.getElementById('customerModalTitle');

      // Reset form
      form.reset();
      document.getElementById('customerEditId').value = '';

      if (customerId) {
        // Edit mode
        title.textContent = '🤝 Editar Cliente';
        const customer = allCustomers.find(c => c.id === customerId);
        if (customer) {
          document.getElementById('customerEditId').value = customer.id;
          document.getElementById('customerName').value = customer.name || '';
          document.getElementById('customerCrmId').value = customer.crm_id || '';
          document.getElementById('customerMrr').value = customer.mrr || 0;
          document.getElementById('customerStatus').value = customer.status || 'active';
          document.getElementById('customerCsm').value = customer.csm_user_id || '';
          document.getElementById('customerOnboardingCompleted').checked = customer.onboarding_completed || false;
          document.getElementById('customerFirstEventDate').value = customer.first_event_date ? customer.first_event_date.split('T')[0] : '';
          document.getElementById('customerLastQbr').value = customer.last_qbr_date ? customer.last_qbr_date.split('T')[0] : '';
          document.getElementById('customerEventsCreated').value = customer.events_created || 0;
          document.getElementById('customerTotalAttendees').value = customer.total_attendees || 0;
          document.getElementById('customerActivationPercent').value = customer.activation_percent || 0;
          document.getElementById('customerHealthScore').value = customer.health_score || 50;
        }
      } else {
        // Create mode
        title.textContent = '🤝 Nuevo Cliente';
        document.getElementById('customerStatus').value = 'active';
        document.getElementById('customerHealthScore').value = 50;
      }

      populateCsmDropdown();
      modal.classList.add('active');
    }

    function closeCustomerModal() {
      document.getElementById('customerModal').classList.remove('active');
    }

    async function populateCsmDropdown() {
      const select = document.getElementById('customerCsm');
      select.innerHTML = '<option value="">Sin asignar</option>';

      // Load all users (in a real app, filter by CSM role)
      try {
        const { data, error } = await supabase
          .from('users')
          .select('id, email, full_name')
          .order('full_name');

        if (error) throw error;

        allCsmUsers = data || [];
        allCsmUsers.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = user.full_name || user.email;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading CSM users:', error);
      }
    }

    async function saveCustomer(event) {
      event.preventDefault();

      if (!currentUser) {
        showToast('Debes iniciar sesión para guardar clientes', 'warning');
        return;
      }

      const editId = document.getElementById('customerEditId').value;
      const name = document.getElementById('customerName').value;
      const crm_id = document.getElementById('customerCrmId').value || null;
      const mrr = parseFloat(document.getElementById('customerMrr').value) || 0;
      const status = document.getElementById('customerStatus').value;
      const csm_user_id = document.getElementById('customerCsm').value || null;
      const onboarding_completed = document.getElementById('customerOnboardingCompleted').checked;
      const first_event_date = document.getElementById('customerFirstEventDate').value || null;
      const last_qbr_date = document.getElementById('customerLastQbr').value || null;
      const events_created = parseInt(document.getElementById('customerEventsCreated').value) || 0;
      const total_attendees = parseInt(document.getElementById('customerTotalAttendees').value) || 0;
      const activation_percent = parseInt(document.getElementById('customerActivationPercent').value) || 0;
      let health_score = parseInt(document.getElementById('customerHealthScore').value) || 50;

      // Auto-calculate health score if still at default 50
      if (health_score === 50) {
        health_score = calculateCustomerHealthScore({
          mrr,
          status,
          onboarding_completed,
          events_created,
          activation_percent
        });
      }

      const customerData = {
        name,
        crm_id,
        mrr,
        status,
        csm_user_id,
        onboarding_completed,
        first_event_date,
        last_qbr_date,
        events_created,
        total_attendees,
        activation_percent,
        health_score,
        updated_at: new Date().toISOString()
      };

      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');

      await withButtonLoading(submitBtn, async () => {
        try {
          if (editId) {
            // Update existing customer
            const { error } = await supabase
              .from('customers')
              .update(customerData)
              .eq('id', editId);

            if (error) throw error;
            showToast(`Cliente actualizado: ${name}`, 'success');

            // Track customer update
            analytics.track('customer_updated', {
              customer_id: editId,
              mrr: mrr,
              status: status,
              health_score: health_score
            });
          } else {
            // Create new customer
            customerData.id = generateId();
            customerData.created_at = new Date().toISOString();

            const { error } = await supabase
              .from('customers')
              .insert([customerData]);

            if (error) throw error;
            showToast(`Cliente creado: ${name}`, 'success');

            // Track customer creation
            analytics.track('customer_created', {
              customer_id: customerData.id,
              mrr: mrr,
              status: status,
              health_score: health_score
            });
          }

          closeCustomerModal();

          // Reload customers if on CS dashboard
          if (currentView === 'cs-dashboard') {
            await loadAllCustomers();
            await renderCSDashboard();
          }
        } catch (error) {
          handleSupabaseError(error, editId ? 'actualizar cliente' : 'crear cliente');
          throw error;
        }
      });
    }

    async function loadAllCustomers() {
      try {
        const { data, error } = await supabase
          .from('customers')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allCustomers = data || [];
        return allCustomers;
      } catch (error) {
        handleSupabaseError(error, 'cargar clientes');
        return [];
      }
    }

    async function deleteCustomer(customerId) {
      // Get customer name for confirmation
      const customer = allCustomers.find(c => c.id === customerId);
      const customerName = customer?.name || 'este cliente';

      const confirmed = await showConfirmDialog({
        title: '⚠️ Confirmar eliminación',
        message: `¿Estás seguro de eliminar "${customerName}"?`,
        details: 'Esta acción no se puede deshacer. Se perderán todos los datos del cliente.',
        confirmText: 'Sí, eliminar',
        cancelText: 'Cancelar',
        danger: true
      });

      if (!confirmed) return;

      try {
        const { error } = await supabase
          .from('customers')
          .delete()
          .eq('id', customerId);

        if (error) throw error;

        showToast('Cliente eliminado correctamente', 'success');

        // Reload customers
        if (currentView === 'cs-dashboard') {
          await loadAllCustomers();
          await renderCSDashboard();
        }
      } catch (error) {
        handleSupabaseError(error, 'eliminar cliente');
      }
    }

    function calculateCustomerHealthScore(customer) {
      // Simple health score algorithm
      let score = 0;

      // MRR contribution (30 points)
      if (customer.mrr > 1000) score += 30;
      else if (customer.mrr > 500) score += 20;
      else if (customer.mrr > 100) score += 10;

      // Status (20 points)
      if (customer.status === 'active') score += 20;
      else if (customer.status === 'prospect') score += 10;

      // Onboarding (20 points)
      if (customer.onboarding_completed) score += 20;

      // Activity (15 points)
      if (customer.events_created > 10) score += 15;
      else if (customer.events_created > 5) score += 10;
      else if (customer.events_created > 0) score += 5;

      // Activation (15 points)
      score += Math.round((customer.activation_percent / 100) * 15);

      return Math.min(score, 100);
    }

    // Dashboard Functions
    async function loadDepartments() {
      try {
        const { data, error } = await supabase
          .from('departments')
          .select('*')
          .eq('is_active', true)
          .order('id');

        if (error) throw error;

        allDepartments = data || [];
        return allDepartments;
      } catch (error) {
        handleSupabaseError(error, 'cargar departamentos');
        return [];
      }
    }

    async function loadMyOKRs() {
      try {
        const { data, error } = await supabase
          .from('user_okrs')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        myOKRs = data || [];
        return myOKRs;
      } catch (error) {
        handleSupabaseError(error, 'cargar OKRs');
        return [];
      }
    }

    async function loadMyInitiatives() {
      try {
        const { data, error } = await supabase
          .from('initiatives')
          .select('*')
          .eq('owner_id', currentUser.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        myInitiatives = data || [];
        return myInitiatives;
      } catch (error) {
        handleSupabaseError(error, 'cargar initiatives');
        return [];
      }
    }

    // Legacy function - now replaced by switchView()
    function toggleDashboardView() {
      switchView(currentView === 'timeline' ? 'user-dashboard' : 'timeline');
    }

    async function renderMyDashboard() {
      await Promise.all([
        loadMyOKRs(),
        loadMyInitiatives(),
        loadDepartments()
      ]);

      const dashboardContainer = document.getElementById('myDashboardContainer');
      if (!dashboardContainer) {
        return;
      }

      const html = `
        <div class="my-dashboard">
          <div class="dashboard-header">
            <h2>👤 Mi Dashboard</h2>
            <div class="dashboard-actions">
              <button class="btn-secondary" onclick="openOKRModal()">
                ➕ Nuevo OKR
              </button>
              <button class="btn-secondary" onclick="openInitiativeModal()">
                ➕ Nueva Initiative
              </button>
            </div>
          </div>

          <div class="dashboard-stats">
            <div class="stat-card">
              <div class="stat-icon">🎯</div>
              <div class="stat-content">
                <div class="stat-value">${myOKRs.length}</div>
                <div class="stat-label">Mis OKRs</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">🚀</div>
              <div class="stat-content">
                <div class="stat-value">${myInitiatives.length}</div>
                <div class="stat-label">Initiatives</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">✅</div>
              <div class="stat-content">
                <div class="stat-value">${calculateCompletedOKRs()}</div>
                <div class="stat-label">OKRs Completados</div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">📊</div>
              <div class="stat-content">
                <div class="stat-value">${calculateAvgProgress()}%</div>
                <div class="stat-label">Progreso Promedio</div>
              </div>
            </div>
          </div>

          <div class="dashboard-section">
            <h3>🎯 Mis OKRs</h3>
            <div class="okrs-list">
              ${renderOKRsList()}
            </div>
          </div>

          <div class="dashboard-section">
            <h3>🚀 Mis Initiatives</h3>
            <div class="initiatives-list">
              ${renderInitiativesList()}
            </div>
          </div>
        </div>
      `;

      dashboardContainer.innerHTML = html;
    }

    function renderOKRsList() {
      if (myOKRs.length === 0) {
        return '<p class="empty-state">No tienes OKRs creados todavía.</p>';
      }

      return myOKRs.map(okr => {
        const statusColor = {
          'completed': 'var(--success)',
          'on_track': 'var(--success)',
          'at_risk': 'var(--warning)',
          'off_track': 'var(--danger)',
          'not_started': 'var(--muted)'
        }[okr.status] || 'var(--muted)';

        const statusText = {
          'completed': '✅ Completado',
          'on_track': '🟢 On Track',
          'at_risk': '🟡 At Risk',
          'off_track': '🔴 Off Track',
          'not_started': '⚪ No iniciado'
        }[okr.status] || okr.status;

        const keyResults = Array.isArray(okr.key_results) ? okr.key_results : [];

        return `
          <div class="okr-card" style="background: var(--bg); border: 1px solid var(--stroke); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 4px 0;">${okr.title}</h4>
                <span style="font-size: 13px; color: var(--muted);">${okr.quarter} • ${okr.deadline || 'Sin deadline'}</span>
              </div>
              <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; background: ${statusColor}20; color: ${statusColor};">
                ${statusText}
              </span>
            </div>

            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-size: 13px; color: var(--muted);">Progreso</span>
                <span style="font-size: 13px; font-weight: 600; color: var(--accent1);">${okr.progress || 0}%</span>
              </div>
              <div role="progressbar" aria-valuenow="${okr.progress || 0}" aria-valuemin="0" aria-valuemax="100" aria-label="Progreso del OKR: ${okr.progress || 0}%" style="width: 100%; height: 6px; background: var(--stroke); border-radius: 3px; overflow: hidden;">
                <div style="width: ${okr.progress || 0}%; height: 100%; background: linear-gradient(90deg, var(--accent1), var(--accent2)); transition: width 0.3s;"></div>
              </div>
            </div>

            ${keyResults.length > 0 ? `
              <div style="margin-top: 12px;">
                <strong style="font-size: 13px; color: var(--muted);">Key Results:</strong>
                ${keyResults.slice(0, 3).map(kr => `
                  <div style="margin-top: 8px; padding-left: 8px; border-left: 2px solid var(--stroke);">
                    <div style="font-size: 13px; color: var(--ink); margin-bottom: 2px;">${kr.description}</div>
                    <div style="font-size: 12px; color: var(--muted);">
                      ${kr.current || 0} / ${kr.target} ${kr.unit} (${kr.progress || 0}%)
                    </div>
                  </div>
                `).join('')}
                ${keyResults.length > 3 ? `<div style="font-size: 12px; color: var(--muted); margin-top: 8px;">+${keyResults.length - 3} más...</div>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function renderInitiativesList() {
      if (myInitiatives.length === 0) {
        return '<p class="empty-state">No tienes Initiatives creadas todavía.</p>';
      }

      return myInitiatives.map(initiative => {
        const healthColor = {
          'on_track': 'var(--success)',
          'at_risk': 'var(--warning)',
          'off_track': 'var(--danger)'
        }[initiative.health] || 'var(--muted)';

        const healthIcon = {
          'on_track': '🟢',
          'at_risk': '🟡',
          'off_track': '🔴'
        }[initiative.health] || '⚪';

        const budgetPercent = initiative.budget_allocated > 0
          ? Math.round((initiative.budget_spent / initiative.budget_allocated) * 100)
          : 0;

        return `
          <div class="initiative-card" style="background: var(--bg); border: 1px solid var(--stroke); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div style="flex: 1;">
                <h4 style="margin: 0 0 4px 0;">${initiative.title}</h4>
                <span style="font-size: 13px; color: var(--muted);">${initiative.quarter || 'Sin trimestre'}</span>
              </div>
              <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; background: ${healthColor}20; color: ${healthColor};">
                ${healthIcon} ${initiative.health}
              </span>
            </div>

            ${initiative.description ? `
              <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">${initiative.description}</p>
            ` : ''}

            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-size: 13px; color: var(--muted);">Progreso</span>
                <span style="font-size: 13px; font-weight: 600; color: var(--accent1);">${initiative.progress || 0}%</span>
              </div>
              <div role="progressbar" aria-valuenow="${initiative.progress || 0}" aria-valuemin="0" aria-valuemax="100" aria-label="Progreso de la iniciativa: ${initiative.progress || 0}%" style="width: 100%; height: 6px; background: var(--stroke); border-radius: 3px; overflow: hidden;">
                <div style="width: ${initiative.progress || 0}%; height: 100%; background: linear-gradient(90deg, var(--accent1), var(--accent2)); transition: width 0.3s;"></div>
              </div>
            </div>

            ${initiative.budget_allocated > 0 ? `
              <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px;">
                <span style="color: var(--muted);">Budget:</span>
                <span style="color: var(--ink);">
                  €${(initiative.budget_spent || 0).toLocaleString()} / €${initiative.budget_allocated.toLocaleString()}
                  <span style="color: ${budgetPercent > 90 ? 'var(--danger)' : 'var(--muted)'};">(${budgetPercent}%)</span>
                </span>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function calculateCompletedOKRs() {
      return myOKRs.filter(okr => okr.status === 'completed').length;
    }

    function calculateAvgProgress() {
      if (myOKRs.length === 0) return 0;
      const totalProgress = myOKRs.reduce((sum, okr) => sum + (okr.progress || 0), 0);
      return Math.round(totalProgress / myOKRs.length);
    }

    // ================================================================
    // TOAST NOTIFICATION SYSTEM
    // ================================================================

    // ============================================
    // CONFIRMATION DIALOG SYSTEM
    // ============================================
    function showConfirmDialog(options) {
      return new Promise((resolve) => {
        const {
          title = '⚠️ Confirmar acción',
          message = '¿Estás seguro?',
          details = '',
          confirmText = 'Confirmar',
          cancelText = 'Cancelar',
          danger = false
        } = options;

        const modal = document.getElementById('confirmDialog');
        const titleEl = document.getElementById('confirmDialogTitle');
        const messageEl = document.getElementById('confirmDialogMessage');
        const detailsEl = document.getElementById('confirmDialogDetails');
        const confirmBtn = document.getElementById('confirmDialogConfirm');
        const cancelBtn = document.getElementById('confirmDialogCancel');

        titleEl.textContent = title;
        messageEl.textContent = message;
        detailsEl.textContent = details;
        confirmBtn.textContent = confirmText;
        cancelBtn.textContent = cancelText;

        // Apply danger style if needed
        if (danger) {
          confirmBtn.className = 'btn btn-danger';
        } else {
          confirmBtn.className = 'btn btn-primary';
        }

        modal.style.display = 'flex';

        const cleanup = () => {
          modal.style.display = 'none';
          confirmBtn.onclick = null;
          cancelBtn.onclick = null;
        };

        confirmBtn.onclick = () => {
          cleanup();
          resolve(true);
        };

        cancelBtn.onclick = () => {
          cleanup();
          resolve(false);
        };

        // Close on escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            cleanup();
            resolve(false);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
      });
    }

    function showToast(message, type = 'info', title = null, duration = 5000) {
      const container = document.getElementById('toastContainer');

      const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
      };

      const titles = {
        success: title || 'Éxito',
        error: title || 'Error',
        warning: title || 'Advertencia',
        info: title || 'Información'
      };

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'polite');
      toast.setAttribute('aria-atomic', 'true');

      // Use safeSetHTML to prevent XSS in user messages
      safeSetHTML(toast, `
        <div class="toast-icon" aria-hidden="true">${icons[type]}</div>
        <div class="toast-content">
          <div class="toast-title">${titles[type]}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Cerrar notificación">×</button>
      `);

      container.appendChild(toast);

      // Auto-remove after duration
      if (duration > 0) {
        setTimeout(() => {
          toast.classList.add('removing');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      // Click to dismiss
      toast.addEventListener('click', (e) => {
        if (!e.target.classList.contains('toast-close')) {
          toast.classList.add('removing');
          setTimeout(() => toast.remove(), 300);
        }
      });

      return toast;
    }

    // ==================================================================
    // XSS PROTECTION HELPERS
    // ==================================================================

    /**
     * Sanitize HTML to prevent XSS attacks
     * @param {string} dirty - Untrusted HTML string
     * @param {object} config - DOMPurify configuration (optional)
     * @returns {string} Sanitized HTML
     */
    function sanitizeHTML(dirty, config = {}) {
      if (typeof DOMPurify === 'undefined') {
        console.error('DOMPurify not loaded');
        return '';
      }
      return DOMPurify.sanitize(dirty, config);
    }

    /**
     * Safely set innerHTML with XSS protection
     * @param {HTMLElement} element - Target element
     * @param {string} html - HTML content to set
     * @param {object} config - DOMPurify configuration (optional)
     */
    function safeSetHTML(element, html, config = {}) {
      if (!element) return;
      element.innerHTML = sanitizeHTML(html, config);
    }

    // ==================================================================
    // LOADING STATE HELPERS
    // ==================================================================

    /**
     * Set loading state on a button
     * @param {HTMLElement|string} button - Button element or selector
     * @param {boolean} isLoading - Loading state
     * @param {string} originalText - Text to restore when done (optional)
     */
    function setButtonLoading(button, isLoading, originalText = null) {
      const btn = typeof button === 'string' ? document.querySelector(button) : button;
      if (!btn) return;

      if (isLoading) {
        btn.dataset.originalText = originalText || btn.textContent;
        btn.classList.add('loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('loading');
        btn.disabled = false;
        if (btn.dataset.originalText) {
          btn.textContent = btn.dataset.originalText;
          delete btn.dataset.originalText;
        }
      }
    }

    /**
     * Set loading state on a form
     * @param {HTMLElement|string} form - Form element or selector
     * @param {boolean} isLoading - Loading state
     */
    function setFormLoading(form, isLoading) {
      const formEl = typeof form === 'string' ? document.querySelector(form) : form;
      if (!formEl) return;

      if (isLoading) {
        formEl.classList.add('form-loading');
        // Disable all inputs
        formEl.querySelectorAll('input, select, textarea, button').forEach(el => {
          el.dataset.wasDisabled = el.disabled;
          el.disabled = true;
        });
      } else {
        formEl.classList.remove('form-loading');
        // Re-enable inputs that weren't disabled
        formEl.querySelectorAll('input, select, textarea, button').forEach(el => {
          if (el.dataset.wasDisabled === 'false') {
            el.disabled = false;
          }
          delete el.dataset.wasDisabled;
        });
      }
    }

    /**
     * Wrap async function with loading state on button
     * @param {HTMLElement} button - Button element
     * @param {Function} asyncFn - Async function to execute
     * @returns {Promise} Result of async function
     */
    async function withButtonLoading(button, asyncFn) {
      setButtonLoading(button, true);
      try {
        return await asyncFn();
      } finally {
        setButtonLoading(button, false);
      }
    }

    /**
     * Wrap async function with loading state on form
     * @param {HTMLElement} form - Form element
     * @param {Function} asyncFn - Async function to execute
     * @returns {Promise} Result of async function
     */
    async function withFormLoading(form, asyncFn) {
      setFormLoading(form, true);
      try {
        return await asyncFn();
      } finally {
        setFormLoading(form, false);
      }
    }

    // Offline/Online detection
    function setupOfflineDetection() {
      const indicator = document.getElementById('offlineIndicator');

      window.addEventListener('offline', () => {
        indicator.classList.add('show');
        showToast(
          'Has perdido la conexión a Internet. Los cambios se guardarán cuando vuelvas a estar online.',
          'warning',
          'Sin conexión',
          10000
        );
      });

      window.addEventListener('online', () => {
        indicator.classList.remove('show');
        showToast(
          'Conexión restaurada. Todos los sistemas funcionando correctamente.',
          'success',
          'Conectado',
          5000
        );
      });

      // Check initial state
      if (!navigator.onLine) {
        indicator.classList.add('show');
      }
    }

    // Enhanced error handling for Supabase operations
    function handleSupabaseError(error, operation = 'operación') {
      console.error(`❌ Error en ${operation}:`, error);

      let message = `Hubo un problema al realizar la ${operation}.`;
      let title = 'Error';

      if (error.message) {
        if (error.message.includes('JWT')) {
          message = 'Tu sesión ha expirado. Por favor, inicia sesión nuevamente.';
          title = 'Sesión expirada';
          setTimeout(() => handleLogout(), 2000);
        } else if (error.message.includes('network')) {
          message = 'Error de conexión. Verifica tu conexión a Internet.';
          title = 'Error de red';
        } else if (error.message.includes('permission') || error.message.includes('policy')) {
          message = 'No tienes permisos para realizar esta acción.';
          title = 'Permisos insuficientes';
        } else {
          message = error.message;
        }
      }

      showToast(message, 'error', title, 8000);
    }

    // Replace all alert() calls with showToast()
    const originalAlert = window.alert;
    window.alert = function(message) {
      // Determine type based on message content
      let type = 'info';
      if (message.includes('✅') || message.toLowerCase().includes('éxito')) {
        type = 'success';
      } else if (message.includes('❌') || message.toLowerCase().includes('error')) {
        type = 'error';
      } else if (message.includes('⚠️') || message.toLowerCase().includes('advertencia')) {
        type = 'warning';
      }

      showToast(message.replace(/✅|❌|⚠️|ℹ️/g, '').trim(), type);
    };

    // ================================================================
    // INITIALIZATION
    // ================================================================

    // ================================================================
    // NAVIGATION SYSTEM
    // ================================================================

    let currentView = 'timeline';

    function switchView(viewName) {
      currentView = viewName;

      // Track view change
      analytics.track('view_changed', {
        view: viewName,
        previous_view: currentView
      });

      // Update tabs
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.view === viewName) {
          tab.classList.add('active');
        }
      });

      // Hide all views
      document.getElementById('timelineView').style.display = 'none';
      document.getElementById('userDashboardView').style.display = 'none';
      document.getElementById('ceoDashboardView').style.display = 'none';
      document.getElementById('directorDashboardView').style.display = 'none';
      document.getElementById('csDashboardView').style.display = 'none';

      // Show selected view
      if (viewName === 'timeline') {
        document.getElementById('timelineView').style.display = 'block';
      } else if (viewName === 'user-dashboard') {
        document.getElementById('userDashboardView').style.display = 'block';
        renderMyDashboard();
      } else if (viewName === 'ceo-dashboard') {
        document.getElementById('ceoDashboardView').style.display = 'block';
        renderCEODashboard();
      } else if (viewName === 'director-dashboard') {
        document.getElementById('directorDashboardView').style.display = 'block';
        renderDirectorDashboard();
      } else if (viewName === 'cs-dashboard') {
        document.getElementById('csDashboardView').style.display = 'block';
        renderCSDashboard();
      }
    }

    // ================================================================
    // CEO DASHBOARD
    // ================================================================

    async function renderCEODashboard() {
      const container = document.getElementById('ceoDashboardView');

      // Load data
      const companyOKRs = await loadCompanyOKRs();
      const departments = await loadAllDepartmentsWithHealth();
      const companyMetrics = calculateCompanyMetrics(companyOKRs, departments);

      const html = `
        <!-- KPI Hero Cards -->
        <div class="ceo-metrics">
          <div class="kpi-card" role="button" tabindex="0" aria-label="Ver detalles de Company Health: ${companyMetrics.health} puntos" onclick="showMetricDetail('health')">
            <div class="kpi-icon" aria-hidden="true">${companyMetrics.health >= 80 ? '💚' : companyMetrics.health >= 60 ? '🟡' : '🔴'}</div>
            <div class="kpi-content">
              <div class="kpi-label">Company Health</div>
              <div class="kpi-value" style="color: ${companyMetrics.health >= 80 ? 'var(--success)' : companyMetrics.health >= 60 ? 'var(--warning)' : 'var(--danger)'};">
                ${companyMetrics.health}
              </div>
              <div class="kpi-trend ${companyMetrics.healthTrend >= 0 ? 'positive' : 'negative'}">
                ${companyMetrics.healthTrend >= 0 ? '↗' : '↘'} ${Math.abs(companyMetrics.healthTrend)} vs Q3
              </div>
            </div>
          </div>

          <div class="kpi-card" role="button" tabindex="0" aria-label="Ver detalles de OKR Completion: ${companyMetrics.okrCompletion}%" onclick="showMetricDetail('okrs')">
            <div class="kpi-icon" aria-hidden="true">🎯</div>
            <div class="kpi-content">
              <div class="kpi-label">OKR Completion</div>
              <div class="kpi-value" style="color: var(--accent1);">
                ${companyMetrics.okrCompletion}%
              </div>
              <div class="kpi-trend positive">
                ${companyMetrics.okrsOnTrack} of ${companyMetrics.totalOKRs} on track
              </div>
            </div>
          </div>

          <div class="kpi-card" role="button" tabindex="0" aria-label="Ver detalles de Active Initiatives: ${companyMetrics.activeInitiatives} iniciativas" onclick="showMetricDetail('initiatives')">
            <div class="kpi-icon" aria-hidden="true">🚀</div>
            <div class="kpi-content">
              <div class="kpi-label">Active Initiatives</div>
              <div class="kpi-value" style="color: var(--accent2);">
                ${companyMetrics.activeInitiatives}
              </div>
              <div class="kpi-trend ${companyMetrics.initiativesAtRisk > 0 ? 'negative' : 'positive'}">
                ${companyMetrics.initiativesOnTrack} on track, ${companyMetrics.initiativesAtRisk} at risk
              </div>
            </div>
          </div>

          <div class="kpi-card" role="button" tabindex="0" aria-label="Ver detalles de Budget Utilization: ${companyMetrics.budgetUtilization}%" onclick="showMetricDetail('budget')">
            <div class="kpi-icon" aria-hidden="true">💰</div>
            <div class="kpi-content">
              <div class="kpi-label">Budget Utilization</div>
              <div class="kpi-value" style="color: var(--success);">
                ${companyMetrics.budgetUtilization}%
              </div>
              <div class="kpi-trend ${companyMetrics.budgetUtilization > 90 ? 'negative' : 'positive'}">
                €${(companyMetrics.budgetSpent / 1000).toFixed(0)}K / €${(companyMetrics.budgetTotal / 1000).toFixed(0)}K
              </div>
            </div>
          </div>
        </div>

        <!-- Company OKRs Section -->
        <div style="margin-bottom: var(--space-2xl);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
            <h2 style="font-size: var(--font-size-h2);">🎯 Company OKRs - ${companyOKRs[0]?.fiscal_year || new Date().getFullYear()}</h2>
            <button class="btn btn-primary" onclick="openCompanyOKRModal()">➕ Nuevo OKR de Empresa</button>
          </div>
          <div id="companyOKRsList"></div>
        </div>

        <!-- Department Health Grid -->
        <div>
          <h2 style="font-size: var(--font-size-h2); margin-bottom: var(--space-lg);">🏢 Department Health</h2>
          <div id="departmentHealthGrid"></div>
        </div>
      `;

      container.innerHTML = html;

      // Render sub-components
      renderCompanyOKRsList(companyOKRs);
      renderDepartmentHealthGrid(departments);
    }

    async function loadCompanyOKRs() {
      try {
        const { data, error } = await supabase
          .from('company_okrs')
          .select('*')
          .eq('fiscal_year', '2025')
          .order('created_at', { ascending: false });

        if (error) throw error;
        return data || [];
      } catch (error) {
        handleSupabaseError(error, 'cargar OKRs de empresa');
        return [];
      }
    }

    async function loadAllDepartmentsWithHealth() {
      try {
        const { data, error } = await supabase
          .from('departments')
          .select('*')
          .eq('is_active', true)
          .order('name', { ascending: true });

        if (error) throw error;
        return data || [];
      } catch (error) {
        handleSupabaseError(error, 'cargar departamentos');
        return [];
      }
    }

    function calculateCompanyMetrics(okrs, departments) {
      // Calculate company-wide metrics
      const totalOKRs = okrs.length;
      const okrsOnTrack = okrs.filter(okr => okr.health_score >= 70).length;
      const okrCompletion = totalOKRs > 0 ? Math.round((okrsOnTrack / totalOKRs) * 100) : 0;

      // Department health average
      const avgHealth = departments.length > 0
        ? Math.round(departments.reduce((sum, d) => sum + (d.health_score || 0), 0) / departments.length)
        : 0;

      // Budget calculations
      let budgetTotal = 0;
      let budgetSpent = 0;
      departments.forEach(dept => {
        if (dept.budget) {
          budgetTotal += dept.budget.allocated || 0;
          budgetSpent += dept.budget.spent || 0;
        }
      });

      const budgetUtilization = budgetTotal > 0 ? Math.round((budgetSpent / budgetTotal) * 100) : 0;

      // Mock initiative counts (will be real when initiatives table is populated)
      const activeInitiatives = 23;
      const initiativesOnTrack = 15;
      const initiativesAtRisk = 6;

      return {
        health: avgHealth,
        healthTrend: +5, // Mock trend
        okrCompletion,
        totalOKRs,
        okrsOnTrack,
        activeInitiatives,
        initiativesOnTrack,
        initiativesAtRisk,
        budgetTotal,
        budgetSpent,
        budgetUtilization
      };
    }

    function renderCompanyOKRsList(okrs) {
      const container = document.getElementById('companyOKRsList');

      if (okrs.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
            <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
            <h3>No hay OKRs de empresa creados</h3>
            <p style="margin-top: 12px;">Crea el primer OKR de la empresa para establecer la dirección estratégica.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = okrs.map(okr => {
        const keyResults = okr.key_results || [];
        const avgProgress = keyResults.length > 0
          ? Math.round(keyResults.reduce((sum, kr) => sum + kr.progress, 0) / keyResults.length)
          : 0;

        return `
          <div class="okr-card" style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <h3 style="font-size: 20px; flex: 1;">${okr.objective}</h3>
              <span class="status-badge" style="background: ${okr.health_score >= 80 ? 'rgba(16, 185, 129, 0.2)' : okr.health_score >= 60 ? 'rgba(245, 158, 11, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${okr.health_score >= 80 ? 'var(--success)' : okr.health_score >= 60 ? 'var(--warning)' : 'var(--danger)'};">
                ${okr.health_score >= 80 ? '✓' : okr.health_score >= 60 ? '⚠' : '✗'} ${okr.health_score}/100
              </span>
            </div>

            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-size: 14px; color: var(--muted);">Progress</span>
                <span style="font-size: 14px; font-weight: 600;">${avgProgress}%</span>
              </div>
              <div role="progressbar" aria-valuenow="${avgProgress}" aria-valuemin="0" aria-valuemax="100" aria-label="Progreso del Company OKR: ${avgProgress}%" style="width: 100%; height: 8px; background: var(--neutral-600); border-radius: 4px; overflow: hidden;">
                <div style="width: ${avgProgress}%; height: 100%; background: linear-gradient(90deg, var(--accent1), var(--accent2)); transition: width 0.3s;"></div>
              </div>
            </div>

            <div style="font-size: 13px; color: var(--muted);">
              <strong>Key Results:</strong>
              ${keyResults.slice(0, 3).map(kr => `
                <div style="margin-top: 6px;">• ${kr.description}: ${kr.current}/${kr.target} ${kr.unit} (${kr.progress}%)</div>
              `).join('')}
              ${keyResults.length > 3 ? `<div style="margin-top: 6px;">... +${keyResults.length - 3} more</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderDepartmentHealthGrid(departments) {
      const container = document.getElementById('departmentHealthGrid');

      if (!departments || departments.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--muted);">No hay departamentos activos</div>';
        return;
      }

      container.innerHTML = `
        <div class="dept-health-grid">
          ${departments.map(dept => {
            const healthColor = dept.health_score >= 80 ? 'var(--success)' : dept.health_score >= 60 ? 'var(--warning)' : 'var(--danger)';
            const healthLabel = dept.health_score >= 80 ? '✓ Saludable' : dept.health_score >= 60 ? '⚠ Atención' : '✗ Crítico';

            return `
              <div class="dept-health-card" onclick="showDepartmentDetail('${dept.id}')">
                <div class="dept-health-icon">${dept.icon || '📊'}</div>
                <h4 class="dept-health-name">${dept.name}</h4>
                <div class="dept-health-score">
                  <span style="color: ${healthColor};">${dept.health_score || 0}</span>
                  <span style="font-size: 14px; color: var(--muted);">/100</span>
                </div>
                <div class="dept-health-label" style="color: ${healthColor};">
                  ${healthLabel}
                </div>
                ${dept.okrs && Array.isArray(dept.okrs) && dept.okrs.length > 0 ? `
                  <div class="dept-health-meta">
                    🎯 ${dept.okrs.length} OKRs
                  </div>
                ` : ''}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function showMetricDetail(metricType) {
      showToast(`Drill-down para ${metricType} - Próximamente`, 'info');
    }

    function showDepartmentDetail(deptId) {
      showToast('Vista de departamento - Próximamente', 'info');
    }

    // ================================================================
    // DIRECTOR DASHBOARD
    // ================================================================

    async function renderDirectorDashboard() {
      const container = document.getElementById('directorDashboardView');

      if (!currentUser) {
        container.innerHTML = '<p class="empty-state">Por favor, inicia sesión para ver el dashboard</p>';
        return;
      }

      // Load director's department data
      const department = await loadDirectorDepartment();

      if (!department) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No se encontró departamento</h3>
            <p>Este usuario no está asignado como director de ningún departamento.</p>
          </div>
        `;
        return;
      }

      // Load team OKRs and metrics
      const teamOKRs = await loadTeamOKRs(department.id);
      const teamMembers = await loadTeamMembers(department.id);
      const metrics = calculateDirectorMetrics(department, teamOKRs, teamMembers);

      const html = `
        <!-- Director Header -->
        <div class="director-header">
          <div class="director-title">
            <h1>${department.icon} ${department.name}</h1>
            <span class="dept-badge">Director Dashboard</span>
          </div>
          <div class="director-actions">
            <button class="btn btn-secondary" onclick="openDepartmentOKRModal()">
              ➕ Department OKR
            </button>
            <button class="btn btn-primary" onclick="openTeamReview()">
              📊 Team Review
            </button>
          </div>
        </div>

        <!-- Director Metrics -->
        <div class="director-metrics">
          <div class="metric-card">
            <div class="metric-label">Department Health</div>
            <div class="metric-value" style="color: ${getHealthColor(metrics.health)};">
              ${metrics.health}
            </div>
            <div class="metric-comparison">
              ${metrics.healthTrend >= 0 ? '↗' : '↘'} ${Math.abs(metrics.healthTrend)} vs last quarter
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-label">Team OKRs</div>
            <div class="metric-value">${metrics.okrsOnTrack}/${metrics.totalOKRs}</div>
            <div class="metric-comparison">
              ${metrics.totalOKRs > 0 ? Math.round((metrics.okrsOnTrack / metrics.totalOKRs) * 100) : 0}% on track
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-label">Team Size</div>
            <div class="metric-value">${metrics.teamSize}</div>
            <div class="metric-comparison">
              ${metrics.teamGrowth > 0 ? '+' : ''}${metrics.teamGrowth} since Q3
            </div>
          </div>

          <div class="metric-card">
            <div class="metric-label">Avg. Performance</div>
            <div class="metric-value" style="color: var(--success);">${metrics.avgPerformance}%</div>
            <div class="metric-comparison">
              Based on ${metrics.completedOKRs} completed OKRs
            </div>
          </div>
        </div>

        <!-- Department OKRs Kanban -->
        <div class="department-okrs">
          <div class="section-header">
            <h2 class="section-title">🎯 ${department.name} OKRs</h2>
          </div>
          <div id="okrKanban"></div>
        </div>

        <!-- Budget Section -->
        <div class="budget-section">
          <div class="budget-header">
            <div>
              <div class="budget-subtitle">💰 Budget Total</div>
              <div class="budget-total">€${(metrics.budgetAllocated / 1000).toFixed(0)}K</div>
            </div>
            <div style="text-align: right;">
              <div class="budget-subtitle">Spent</div>
              <div style="font-size: 28px; font-weight: bold; color: ${metrics.budgetPercent > 90 ? 'var(--danger)' : 'var(--ink)'};">
                €${(metrics.budgetSpent / 1000).toFixed(0)}K
              </div>
            </div>
          </div>

          <div class="budget-bar">
            <div class="budget-fill" style="width: ${metrics.budgetPercent}%;">
              ${metrics.budgetPercent}%
            </div>
          </div>

          <div class="budget-breakdown">
            <div class="budget-item">
              <div class="budget-item-label">Allocated</div>
              <div class="budget-item-value" style="color: var(--accent2);">
                €${(metrics.budgetAllocated / 1000).toFixed(0)}K
              </div>
            </div>
            <div class="budget-item">
              <div class="budget-item-label">Spent</div>
              <div class="budget-item-value" style="color: ${metrics.budgetPercent > 90 ? 'var(--danger)' : 'var(--success)'};">
                €${(metrics.budgetSpent / 1000).toFixed(0)}K
              </div>
            </div>
            <div class="budget-item">
              <div class="budget-item-label">Remaining</div>
              <div class="budget-item-value" style="color: var(--muted);">
                €${((metrics.budgetAllocated - metrics.budgetSpent) / 1000).toFixed(0)}K
              </div>
            </div>
          </div>
        </div>

        <!-- Team Members Section -->
        <div class="team-section">
          <div class="section-header">
            <h2 class="section-title">👥 Team Members (${teamMembers.length})</h2>
          </div>
          <div id="teamGrid"></div>
        </div>
      `;

      container.innerHTML = html;

      // Render sub-components
      renderOKRKanban(teamOKRs);
      renderTeamGrid(teamMembers);
    }

    async function loadDirectorDepartment() {
      // For now, get first active department
      // In production, query departments table where lead_user_id = currentUser.id
      try {
        const { data, error } = await supabase
          .from('departments')
          .select('*')
          .eq('is_active', true)
          .limit(1);

        if (error) throw error;
        return data && data.length > 0 ? data[0] : null;
      } catch (error) {
        console.error('Error loading director department:', error);
        return null;
      }
    }

    async function loadTeamOKRs(departmentId) {
      try {
        const { data, error } = await supabase
          .from('user_okrs')
          .select('*, users:user_id(email)')
          .order('created_at', { ascending: false });

        if (error) throw error;
        return data || [];
      } catch (error) {
        handleSupabaseError(error, 'cargar OKRs del equipo');
        return [];
      }
    }

    async function loadTeamMembers(departmentId) {
      // Simulate team members - in production, query users table filtered by department
      return [
        { id: 1, name: 'Ana García', role: 'Senior Marketing Manager', avatar: '👩', okrs: 3, onTrack: 2 },
        { id: 2, name: 'Carlos Ruiz', role: 'Content Strategist', avatar: '👨', okrs: 2, onTrack: 2 },
        { id: 3, name: 'María López', role: 'Social Media Manager', avatar: '👩', okrs: 3, onTrack: 1 },
        { id: 4, name: 'Pedro Sánchez', role: 'Marketing Analyst', avatar: '👨', okrs: 2, onTrack: 1 }
      ];
    }

    function calculateDirectorMetrics(department, teamOKRs, teamMembers) {
      const totalOKRs = teamOKRs.length;
      const okrsOnTrack = teamOKRs.filter(okr => okr.status === 'on_track').length;
      const completedOKRs = teamOKRs.filter(okr => okr.status === 'completed').length;

      const avgPerformance = totalOKRs > 0
        ? Math.round(teamOKRs.reduce((sum, okr) => sum + (okr.progress || 0), 0) / totalOKRs)
        : 0;

      const budgetAllocated = department.budget?.allocated || 120000;
      const budgetSpent = department.budget?.spent || 68000;
      const budgetPercent = Math.round((budgetSpent / budgetAllocated) * 100);

      return {
        health: department.health_score || 75,
        healthTrend: 5,
        totalOKRs,
        okrsOnTrack,
        completedOKRs,
        teamSize: teamMembers.length,
        teamGrowth: 1,
        avgPerformance,
        budgetAllocated,
        budgetSpent,
        budgetPercent
      };
    }

    function renderOKRKanban(teamOKRs) {
      const kanbanContainer = document.getElementById('okrKanban');

      const notStarted = teamOKRs.filter(okr => okr.status === 'not_started');
      const onTrack = teamOKRs.filter(okr => okr.status === 'on_track');
      const completed = teamOKRs.filter(okr => okr.status === 'completed');

      const html = `
        <div class="okr-kanban">
          <!-- Not Started Column -->
          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-title">🔴 Not Started</span>
              <span class="kanban-count">${notStarted.length}</span>
            </div>
            ${notStarted.map(okr => renderOKRCardMini(okr)).join('')}
            ${notStarted.length === 0 ? '<p style="color: var(--muted); font-size: 13px; text-align: center;">No OKRs</p>' : ''}
          </div>

          <!-- On Track Column -->
          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-title">🟢 On Track</span>
              <span class="kanban-count">${onTrack.length}</span>
            </div>
            ${onTrack.map(okr => renderOKRCardMini(okr)).join('')}
            ${onTrack.length === 0 ? '<p style="color: var(--muted); font-size: 13px; text-align: center;">No OKRs</p>' : ''}
          </div>

          <!-- Completed Column -->
          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-title">✅ Completed</span>
              <span class="kanban-count">${completed.length}</span>
            </div>
            ${completed.map(okr => renderOKRCardMini(okr)).join('')}
            ${completed.length === 0 ? '<p style="color: var(--muted); font-size: 13px; text-align: center;">No OKRs</p>' : ''}
          </div>
        </div>
      `;

      kanbanContainer.innerHTML = html;
    }

    function renderOKRCardMini(okr) {
      return `
        <div class="okr-card-mini">
          <h4>${okr.title}</h4>
          <div class="progress-mini">
            ${okr.progress || 0}% complete · ${okr.key_results?.length || 0} KRs
          </div>
        </div>
      `;
    }

    function renderTeamGrid(teamMembers) {
      const gridContainer = document.getElementById('teamGrid');

      const html = `
        <div class="team-grid">
          ${teamMembers.map(member => `
            <div class="team-member-card">
              <div class="member-avatar">${member.avatar}</div>
              <div class="member-info">
                <div class="member-name">${member.name}</div>
                <div class="member-role">${member.role}</div>
                <div class="member-okrs">
                  <strong>${member.onTrack}/${member.okrs}</strong> OKRs on track
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      gridContainer.innerHTML = html;
    }

    function getHealthColor(health) {
      if (health >= 80) return 'var(--success)';
      if (health >= 60) return 'var(--warning)';
      return 'var(--danger)';
    }

    function openDepartmentOKRModal() {
      showToast('Department OKR creation coming soon', 'info');
    }

    function openTeamReview() {
      showToast('Team review feature coming soon', 'info');
    }

    // ================================================================
    // CUSTOMER SUCCESS DASHBOARD
    // ================================================================

    async function renderCSDashboard() {
      const container = document.getElementById('csDashboardView');

      if (!currentUser) {
        container.innerHTML = '<p class="empty-state">Por favor, inicia sesión para ver el dashboard</p>';
        return;
      }

      // Load customers
      const customers = await loadAllCustomers();
      const metrics = calculateCSMetrics(customers);

      const html = `
        <!-- CS Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
          <div>
            <h1 style="font-size: var(--font-size-h1); margin-bottom: var(--space-xs);">🤝 Customer Success</h1>
            <p style="color: var(--muted); font-size: 16px;">Gestión de clientes y health score</p>
          </div>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" onclick="syncCSMetricsToCompanyOKRsManual()">
              🔄 Sincronizar con OKRs
            </button>
            <button class="btn btn-primary" onclick="openCustomerModal()">
              ➕ Nuevo Cliente
            </button>
          </div>
        </div>

        <!-- OKR Contribution Banner -->
        <div style="background: linear-gradient(135deg, rgba(236, 0, 140, 0.1), rgba(92, 194, 229, 0.1)); border: 1px solid var(--stroke); border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: var(--space-2xl);">
          <div style="display: flex; align-items: center; gap: var(--space-md);">
            <div style="font-size: 32px;">🎯</div>
            <div style="flex: 1;">
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">
                Contribución a Company OKRs 2025
              </div>
              <div style="font-size: 13px; color: var(--muted);">
                Tus métricas de CS se sincronizan automáticamente con:
              </div>
              <div style="display: flex; gap: 16px; margin-top: 8px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 20px;">📊</span>
                  <span style="font-size: 13px;"><strong>NRR ${metrics.nrr}%</strong> → OKR "Mantener NRR > 120%"</span>
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 20px;">👥</span>
                  <span style="font-size: 13px;"><strong>${metrics.activeCustomers} clientes</strong> → OKR "Alcanzar 200 clientes activos"</span>
                </div>
              </div>
            </div>
            <div id="syncStatus" style="font-size: 12px; color: var(--muted); text-align: right;">
              Última sync: Nunca
            </div>
          </div>
        </div>

        <!-- CS Metrics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--space-lg); margin-bottom: var(--space-lg);">
          <div class="metric-card">
            <div class="metric-label">Total Clientes</div>
            <div class="metric-value">${metrics.totalCustomers}</div>
            <div class="metric-comparison">
              ${metrics.activeCustomers} activos • ${metrics.prospects} prospectos
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">MRR Total (Activos)</div>
            <div class="metric-value">€${metrics.totalMrr.toLocaleString()}</div>
            <div class="metric-comparison">
              Promedio: €${metrics.avgMrr} por cliente
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Health Score Promedio</div>
            <div class="metric-value" style="color: ${getHealthColor(metrics.avgHealth)};">${metrics.avgHealth}</div>
            <div class="metric-comparison">
              ${metrics.healthyCustomers} clientes saludables (≥80)
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Tasa de Onboarding</div>
            <div class="metric-value">${metrics.onboardingRate}%</div>
            <div class="metric-comparison">
              ${metrics.onboardedCustomers}/${metrics.activeCustomers} completados
            </div>
          </div>
        </div>

        <!-- Advanced CS Metrics (NRR & Churn) -->
        <div style="background: var(--card); border: 1px solid var(--stroke); border-radius: var(--radius-lg); padding: var(--space-xl); margin-bottom: var(--space-2xl);">
          <h3 style="font-size: 18px; margin-bottom: var(--space-lg); display: flex; align-items: center; gap: 8px;">
            📈 Métricas de Retención
            <span style="font-size: 12px; color: var(--muted); font-weight: normal;">(Cálculo manual hasta integración Stripe/Pipedrive)</span>
          </h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg);">
            <div>
              <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Net Revenue Retention (NRR)</div>
              <div style="font-size: 32px; font-weight: bold; color: ${metrics.nrr >= 100 ? 'var(--success)' : 'var(--warning)'};">
                ${metrics.nrr}%
              </div>
              <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                ${metrics.nrr >= 120 ? '🎯 Excelente (>120%)' : metrics.nrr >= 100 ? '✅ Saludable (≥100%)' : '⚠️ Atención (<100%)'}
              </div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Churn Rate (Mensual)</div>
              <div style="font-size: 32px; font-weight: bold; color: ${metrics.churnRate <= 5 ? 'var(--success)' : metrics.churnRate <= 10 ? 'var(--warning)' : 'var(--danger)'};">
                ${metrics.churnRate}%
              </div>
              <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                ${metrics.churnRate <= 5 ? '🎯 Excelente (≤5%)' : metrics.churnRate <= 10 ? '⚠️ Aceptable (≤10%)' : '🔴 Crítico (>10%)'}
              </div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">MRR Growth Rate</div>
              <div style="font-size: 32px; font-weight: bold; color: var(--accent2);">
                +${metrics.mrrGrowthRate}%
              </div>
              <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                Estimado mes a mes
              </div>
            </div>
            <div>
              <div style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">Clientes en Riesgo</div>
              <div style="font-size: 32px; font-weight: bold; color: ${metrics.atRiskCustomers === 0 ? 'var(--success)' : 'var(--danger)'};">
                ${metrics.atRiskCustomers}
              </div>
              <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                Health score < 60
              </div>
            </div>
          </div>

          <!-- Retention Tips -->
          ${metrics.churnRate > 5 || metrics.nrr < 100 ? `
            <div style="margin-top: var(--space-lg); padding: var(--space-md); background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--danger); border-radius: 4px;">
              <div style="font-weight: 600; margin-bottom: 4px;">⚠️ Alertas de Retención</div>
              <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--muted);">
                ${metrics.churnRate > 5 ? '<li>Churn rate elevado - Revisar clientes en riesgo y ejecutar plan de retención</li>' : ''}
                ${metrics.nrr < 100 ? '<li>NRR por debajo de 100% - Enfocar en upsell y cross-sell con clientes existentes</li>' : ''}
                ${metrics.atRiskCustomers > 0 ? `<li>${metrics.atRiskCustomers} cliente(s) en riesgo - Contactar CSM para plan de acción</li>` : ''}
              </ul>
            </div>
          ` : `
            <div style="margin-top: var(--space-lg); padding: var(--space-md); background: rgba(16, 185, 129, 0.1); border-left: 3px solid var(--success); border-radius: 4px;">
              <div style="font-weight: 600; color: var(--success);">✅ Métricas de Retención Saludables</div>
              <div style="font-size: 13px; color: var(--muted); margin-top: 4px;">
                El equipo de CS está manteniendo excelentes niveles de retención y crecimiento.
              </div>
            </div>
          `}
        </div>

        <!-- Customer Segments Tabs -->
        <div style="margin-bottom: var(--space-lg);">
          <div style="display: flex; gap: 8px; border-bottom: 1px solid var(--stroke);">
            <button class="segment-tab active" data-segment="all" onclick="filterCustomerSegment('all')">
              Todos (${metrics.totalCustomers})
            </button>
            <button class="segment-tab" data-segment="active" onclick="filterCustomerSegment('active')">
              Activos (${metrics.activeCustomers})
            </button>
            <button class="segment-tab" data-segment="at-risk" onclick="filterCustomerSegment('at-risk')">
              En Riesgo (${metrics.atRiskCustomers})
            </button>
            <button class="segment-tab" data-segment="churned" onclick="filterCustomerSegment('churned')">
              Churned (${metrics.churnedCustomers})
            </button>
          </div>
        </div>

        <!-- Customer List -->
        <div id="customerList"></div>
      `;

      container.innerHTML = html;
      renderCustomerList(customers, 'all');
    }

    function calculateCSMetrics(customers) {
      const totalCustomers = customers.length;
      const activeCustomers = customers.filter(c => c.status === 'active').length;
      const prospects = customers.filter(c => c.status === 'prospect').length;
      const churnedCustomers = customers.filter(c => c.status === 'churned').length;

      // MRR Calculations
      const activeMrr = customers
        .filter(c => c.status === 'active')
        .reduce((sum, c) => sum + (c.mrr || 0), 0);
      const totalMrr = customers.reduce((sum, c) => sum + (c.mrr || 0), 0);
      const avgMrr = totalCustomers > 0 ? Math.round(totalMrr / totalCustomers) : 0;

      // Health Scores
      const healthScores = customers.map(c => c.health_score || 0);
      const avgHealth = totalCustomers > 0 ? Math.round(healthScores.reduce((sum, h) => sum + h, 0) / totalCustomers) : 0;
      const healthyCustomers = customers.filter(c => (c.health_score || 0) >= 80).length;
      const atRiskCustomers = customers.filter(c => {
        const health = c.health_score || 0;
        return health < 60 && c.status === 'active';
      }).length;

      // Onboarding
      const onboardedCustomers = customers.filter(c => c.onboarding_completed).length;
      const onboardingRate = activeCustomers > 0 ? Math.round((onboardedCustomers / activeCustomers) * 100) : 0;

      // Churn Rate Calculation (monthly)
      // Churn Rate = (Churned Customers / Total Active Customers at Start) * 100
      const churnRate = (activeCustomers + churnedCustomers) > 0
        ? Math.round((churnedCustomers / (activeCustomers + churnedCustomers)) * 100)
        : 0;

      // NRR (Net Revenue Retention) Calculation
      // For manual tracking: NRR = ((Starting MRR + Expansion - Contraction - Churned MRR) / Starting MRR) * 100
      // Simplified: If we have active customers with growing MRR, assume good NRR
      // Real calculation would need historical MRR data
      // For now, estimate based on active customers vs churned
      const estimatedChurnedMrr = churnedCustomers * avgMrr; // Rough estimate
      const nrr = activeMrr > 0
        ? Math.round(((activeMrr - estimatedChurnedMrr) / activeMrr) * 100)
        : 100;

      // Cap NRR at reasonable values (80-150%)
      const nrrCapped = Math.max(80, Math.min(150, nrr));

      // Calculate MRR Growth (month over month estimate)
      // In real scenario, this would compare with previous month's data
      // For now, show potential based on active customers
      const mrrGrowthRate = activeCustomers > 0 ? 5 : 0; // 5% default growth assumption

      return {
        totalCustomers,
        activeCustomers,
        prospects,
        churnedCustomers,
        totalMrr: activeMrr,
        avgMrr,
        avgHealth,
        healthyCustomers,
        atRiskCustomers,
        onboardedCustomers,
        onboardingRate,
        churnRate,
        nrr: nrrCapped,
        mrrGrowthRate
      };
    }

    function renderCustomerList(customers, segment) {
      const container = document.getElementById('customerList');

      // Filter by segment
      let filteredCustomers = customers;
      if (segment === 'active') {
        filteredCustomers = customers.filter(c => c.status === 'active');
      } else if (segment === 'at-risk') {
        filteredCustomers = customers.filter(c => {
          const health = c.health_score || 0;
          return health < 60 && c.status === 'active';
        });
      } else if (segment === 'churned') {
        filteredCustomers = customers.filter(c => c.status === 'churned');
      }

      if (filteredCustomers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No hay clientes en este segmento</h3>
            <p>Los clientes aparecerán aquí cuando los agregues.</p>
          </div>
        `;
        return;
      }

      const html = `
        <div style="display: grid; gap: var(--space-md);">
          ${filteredCustomers.map(customer => {
            const healthColor = getHealthColor(customer.health_score || 0);
            const statusIcon = customer.status === 'active' ? '✅' : customer.status === 'prospect' ? '🔍' : '❌';
            const statusLabel = customer.status === 'active' ? 'Activo' : customer.status === 'prospect' ? 'Prospecto' : 'Churned';

            return `
              <div class="customer-card" style="background: var(--card); border: 1px solid var(--stroke); border-radius: var(--radius-lg); padding: var(--space-lg); display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-sm);">
                    <h3 style="font-size: 18px; margin: 0;">${customer.name}</h3>
                    <span style="background: ${customer.status === 'active' ? 'var(--success)' : customer.status === 'prospect' ? 'var(--accent2)' : 'var(--danger)'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                      ${statusIcon} ${statusLabel}
                    </span>
                    ${customer.onboarding_completed ? '<span style="background: var(--accent1); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">✓ Onboarded</span>' : ''}
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--space-md); margin-top: var(--space-sm);">
                    <div>
                      <div style="font-size: 12px; color: var(--muted);">MRR</div>
                      <div style="font-weight: 600;">€${(customer.mrr || 0).toLocaleString()}/mes</div>
                    </div>
                    <div>
                      <div style="font-size: 12px; color: var(--muted);">Health Score</div>
                      <div style="font-weight: 600; color: ${healthColor};">${customer.health_score || 0}/100</div>
                    </div>
                    <div>
                      <div style="font-size: 12px; color: var(--muted);">Eventos</div>
                      <div style="font-weight: 600;">${customer.events_created || 0}</div>
                    </div>
                    <div>
                      <div style="font-size: 12px; color: var(--muted);">Activación</div>
                      <div style="font-weight: 600;">${customer.activation_percent || 0}%</div>
                    </div>
                  </div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-secondary" style="padding: 8px 16px;" onclick="openCustomerModal('${customer.id}')">
                    ✏️ Editar
                  </button>
                  <button class="btn" style="padding: 8px 16px; background: var(--danger); color: white;" onclick="deleteCustomer('${customer.id}')">
                    🗑️ Eliminar
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      container.innerHTML = html;
    }

    function filterCustomerSegment(segment) {
      // Update active tab
      document.querySelectorAll('.segment-tab').forEach(tab => {
        if (tab.dataset.segment === segment) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // Re-render customer list
      renderCustomerList(allCustomers, segment);
    }

    // ================================================================
    // CS METRICS → COMPANY OKRs INTEGRATION
    // ================================================================

    async function syncCSMetricsToCompanyOKRs() {
      try {
        // Load customers and calculate CS metrics
        const customers = await loadAllCustomers();
        const metrics = calculateCSMetrics(customers);

        // Load Company OKRs
        const { data: companyOKRs, error: loadError } = await supabase
          .from('company_okrs')
          .select('*')
          .eq('fiscal_year', '2025');

        if (loadError) throw loadError;

        // Find growth OKR (contains NRR key result)
        const growthOKR = companyOKRs.find(okr => okr.id === 'co-2025-growth');
        if (!growthOKR) return;

        // Update NRR Key Result (kr-3)
        const keyResults = growthOKR.key_results;
        const nrrKR = keyResults.find(kr => kr.id === 'kr-3');
        const customersKR = keyResults.find(kr => kr.id === 'kr-2');

        if (nrrKR) {
          nrrKR.current = metrics.nrr;
          nrrKR.progress = Math.min(Math.round((metrics.nrr / nrrKR.target) * 100), 100);
        }

        if (customersKR) {
          customersKR.current = metrics.activeCustomers;
          customersKR.progress = Math.min(Math.round((metrics.activeCustomers / customersKR.target) * 100), 100);
        }

        // Recalculate health score
        const avgProgress = keyResults.reduce((sum, kr) => sum + kr.progress, 0) / keyResults.length;
        const newHealthScore = Math.round(avgProgress);

        // Update Company OKR
        const { error: updateError } = await supabase
          .from('company_okrs')
          .update({
            key_results: keyResults,
            health_score: newHealthScore,
            updated_at: new Date().toISOString()
          })
          .eq('id', 'co-2025-growth');

        if (updateError) throw updateError;

        console.log('✅ CS Metrics synced to Company OKRs:', {
          nrr: metrics.nrr,
          activeCustomers: metrics.activeCustomers,
          healthScore: newHealthScore
        });

        return true;
      } catch (error) {
        console.error('Error syncing CS metrics to Company OKRs:', error);
        return false;
      }
    }

    // Manual sync trigger with user feedback
    async function syncCSMetricsToCompanyOKRsManual() {
      const button = event.target;
      const originalText = button.innerHTML;

      button.innerHTML = '⏳ Sincronizando...';
      button.disabled = true;

      const success = await syncCSMetricsToCompanyOKRs();

      if (success) {
        button.innerHTML = '✅ Sincronizado';
        showToast('Métricas de CS sincronizadas con Company OKRs', 'success');

        // Update sync status
        const syncStatus = document.getElementById('syncStatus');
        if (syncStatus) {
          const now = new Date();
          syncStatus.innerHTML = `Última sync: ${now.toLocaleTimeString('es-ES')}`;
        }

        setTimeout(() => {
          button.innerHTML = originalText;
          button.disabled = false;
        }, 2000);
      } else {
        button.innerHTML = '❌ Error';
        showToast('Error al sincronizar métricas', 'error');

        setTimeout(() => {
          button.innerHTML = originalText;
          button.disabled = false;
        }, 2000);
      }
    }

    // Auto-sync CS metrics when customer is saved/deleted
    const originalSaveCustomer = saveCustomer;
    saveCustomer = async function(event) {
      await originalSaveCustomer(event);
      // Sync metrics to Company OKRs after save
      setTimeout(() => syncCSMetricsToCompanyOKRs(), 500);
    };

    const originalDeleteCustomer = deleteCustomer;
    deleteCustomer = async function(customerId) {
      await originalDeleteCustomer(customerId);
      // Sync metrics to Company OKRs after delete
      setTimeout(() => syncCSMetricsToCompanyOKRs(), 500);
    };

    // ================================================================
    // VIEW AS USER SYSTEM (Multi-Tenant Interno)
    // ================================================================

    let originalUser = null;     // Usuario autenticado real
    let viewingAsUser = null;    // Usuario que estamos viendo como
    let allUsersForSwitch = [];  // Lista de usuarios disponibles según jerarquía

    async function initializeViewAsSystem() {
      // Solo disponible para CEO
      if (!currentUser || currentUser.role !== 'ceo') {
        return;
      }

      // Mostrar el selector
      document.getElementById('viewAsSelector').style.display = 'inline-block';

      // Guardar usuario original si no está guardado
      if (!originalUser) {
        originalUser = { ...currentUser };
      }

      // Cargar usuarios disponibles según jerarquía
      await loadUsersForViewAs();

      // Actualizar badge
      updateCurrentUserBadge();
    }

    async function loadUsersForViewAs() {
      try {
        const { data: users, error } = await supabase
          .from('users')
          .select('*')
          .order('role', { ascending: false });

        if (error) throw error;

        allUsersForSwitch = users || [];
        renderUserList();
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function renderUserList() {
      const container = document.getElementById('userListContainer');
      if (!container || allUsersForSwitch.length === 0) return;

      const roleOrder = { ceo: 1, director: 2, csm: 3, user: 4 };
      const sortedUsers = [...allUsersForSwitch].sort((a, b) => {
        return (roleOrder[a.role] || 999) - (roleOrder[b.role] || 999);
      });

      const html = sortedUsers.map(user => {
        const isActive = currentUser.id === user.id;
        const roleIcon = getRoleIcon(user.role);
        const roleClass = `role-${user.role}`;

        return `
          <div class="user-item ${isActive ? 'active' : ''}" onclick="switchToUser('${user.id}')">
            <div class="user-item-icon">${roleIcon}</div>
            <div class="user-item-info">
              <div class="user-item-name">${user.full_name || user.email.split('@')[0]}</div>
              <div class="user-item-email">${user.email}</div>
            </div>
            <span class="user-item-role ${roleClass}">${user.role}</span>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    function getRoleIcon(role) {
      const icons = {
        ceo: '🌍',
        director: '👥',
        csm: '🤝',
        user: '👤'
      };
      return icons[role] || '👤';
    }

    function toggleViewAsDropdown() {
      const dropdown = document.getElementById('viewAsDropdown');
      if (!dropdown) return;

      const isVisible = dropdown.style.display === 'block';
      dropdown.style.display = isVisible ? 'none' : 'block';

      // Cerrar al hacer click fuera
      if (!isVisible) {
        setTimeout(() => {
          document.addEventListener('click', closeDropdownOnClickOutside);
        }, 10);
      }
    }

    function closeDropdownOnClickOutside(event) {
      const dropdown = document.getElementById('viewAsDropdown');
      const button = document.getElementById('viewAsButton');

      if (dropdown && button) {
        if (!dropdown.contains(event.target) && !button.contains(event.target)) {
          dropdown.style.display = 'none';
          document.removeEventListener('click', closeDropdownOnClickOutside);
        }
      }
    }

    async function switchToUser(userId) {
      // Cerrar dropdown
      document.getElementById('viewAsDropdown').style.display = 'none';

      // Buscar usuario
      const user = allUsersForSwitch.find(u => u.id === userId);
      if (!user) return;

      // Si es el usuario original, salir del modo View As
      if (originalUser && userId === originalUser.id) {
        exitViewAsMode();
        return;
      }

      // Guardar usuario original si no existe
      if (!originalUser) {
        originalUser = { ...currentUser };
      }

      // Cambiar contexto
      viewingAsUser = user;
      currentUser.id = user.id;
      currentUser.email = user.email;
      currentUser.role = user.role;
      currentUser.full_name = user.full_name;
      currentUser.department_id = user.department_id;

      // Track view as switch
      analytics.track('view_as_switch', {
        target_user_id: user.id,
        target_role: user.role,
        original_role: originalUser.role
      });

      // Mostrar banner y overlay
      document.getElementById('viewingAsBanner').style.display = 'block';
      document.getElementById('viewingAsEmail').textContent = user.email;
      document.querySelector('.container').classList.add('viewing-as-mode');

      // Actualizar badge
      updateCurrentUserBadge();

      // Reload todos los datos del nuevo usuario
      await reloadAllUserData();

      // Actualizar navegación
      initializeRoleBasedNav();

      // Cambiar a vista por defecto del nuevo rol
      if (user.role === 'ceo') {
        switchView('ceo-dashboard');
      } else if (user.role === 'director') {
        switchView('director-dashboard');
      } else if (user.role === 'csm') {
        switchView('cs-dashboard');
      } else {
        switchView('user-dashboard');
      }

      showToast(`Vista cambiada a: ${user.email}`, 'info');
    }

    function updateCurrentUserBadge() {
      const badge = document.getElementById('currentUserBadge');
      if (!badge) return;

      const displayName = currentUser.full_name || currentUser.email.split('@')[0];
      const roleIcon = getRoleIcon(currentUser.role);

      badge.innerHTML = `${roleIcon} ${displayName}`;
    }

    async function reloadAllUserData() {
      try {
        // Limpiar datos actuales
        myOKRs = [];
        myInitiatives = [];
        allCustomers = [];

        // Reload según el rol
        await loadData();
        await loadMyOKRs();
        await loadMyInitiatives();

        if (currentUser.role === 'director' || currentUser.role === 'ceo') {
          await loadDepartments();
        }

        if (currentUser.role === 'csm' || currentUser.role === 'ceo') {
          await loadAllCustomers();
        }

        // Renderizar dashboard actual
        const currentViewId = document.querySelector('.nav-tab.active')?.dataset.view;
        if (currentViewId) {
          switchView(currentViewId);
        }

      } catch (error) {
        console.error('Error reloading user data:', error);
        showToast('Error al cargar datos del usuario', 'error');
      }
    }

    function exitViewAsMode() {
      if (!originalUser) return;

      // Restaurar usuario original
      currentUser.id = originalUser.id;
      currentUser.email = originalUser.email;
      currentUser.role = originalUser.role;
      currentUser.full_name = originalUser.full_name;
      currentUser.department_id = originalUser.department_id;

      viewingAsUser = null;

      // Track exit view as
      analytics.track('view_as_exit', {
        original_role: originalUser.role
      });

      // Ocultar banner y remover overlay
      document.getElementById('viewingAsBanner').style.display = 'none';
      document.querySelector('.container').classList.remove('viewing-as-mode');

      // Actualizar badge
      updateCurrentUserBadge();

      // Reload datos
      reloadAllUserData();

      // Actualizar navegación
      initializeRoleBasedNav();

      // Volver a CEO dashboard
      switchView('ceo-dashboard');

      showToast('Has vuelto a tu cuenta', 'success');
    }

    // ================================================================
    // INITIALIZATION
    // ================================================================

    window.addEventListener('DOMContentLoaded', () => {
      checkSession();
      setupOfflineDetection();
      initializeRoleBasedNav();

      // Show welcome message when user logs in successfully
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('welcome') === 'true') {
        setTimeout(() => {
          showToast(
            'Bienvenido a Nevent Strategic Execution Platform',
            'success',
            '¡Hola!',
            4000
          );
        }, 500);
      }
    });

    function initializeRoleBasedNav() {
      // Role-based navigation with proper permission checks
      if (!currentUser) return;

      const userRole = currentUser.role || 'user';

      // Show CEO Dashboard only to CEOs
      const ceoTab = document.querySelector('[data-required-role="ceo"]');
      if (ceoTab) {
        if (userRole === 'ceo') {
          ceoTab.setAttribute('data-user-has-role', 'true');
          ceoTab.style.display = 'flex';
        } else {
          ceoTab.style.display = 'none';
        }
      }

      // Show Director Dashboard to Directors and CEOs
      const directorTab = document.querySelector('[data-required-role="director"]');
      if (directorTab) {
        if (userRole === 'director' || userRole === 'ceo') {
          directorTab.setAttribute('data-user-has-role', 'true');
          directorTab.style.display = 'flex';
        } else {
          directorTab.style.display = 'none';
        }
      }

      // Show CS Dashboard to CSMs, Directors, and CEOs
      const csmTab = document.querySelector('[data-required-role="csm"]');
      if (csmTab) {
        if (userRole === 'csm' || userRole === 'director' || userRole === 'ceo') {
          csmTab.setAttribute('data-user-has-role', 'true');
          csmTab.style.display = 'flex';
        } else {
          csmTab.style.display = 'none';
        }
      }
    }
  </script>
</body>
</html>
